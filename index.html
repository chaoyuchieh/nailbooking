<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nail Collector | é ç´„ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #ffffff;
            color: #333;
            -webkit-tap-highlight-color: transparent;
        }
        .rounded-custom { border-radius: 24px; }
        .btn-toggle {
            transition: all 0.2s ease;
            background-color: #f3f4f6; /* Light Gray */
            color: #666;
            border: 1px solid transparent;
        }
        .btn-toggle.active {
            background-color: #4b5563; /* Dark Gray */
            color: #ffffff;
            border-color: #374151;
        }
        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            font-size: 0.8rem;
            transition: all 0.2s;
            position: relative;
        }
        .calendar-day.available { background-color: #fff; border: 1px solid #eee; color: #333; }
        .calendar-day.booked { background-color: #f3f4f6; color: #d1d5db; cursor: not-allowed; border: 1px solid transparent; }
        .calendar-day.past { background-color: #f9fafb; color: #e5e7eb; cursor: not-allowed; } 
        .calendar-day.selected { background-color: #4b5563; color: #fff; border-color: #4b5563; }

        /* Admin Calendar Styles - Expanded for details */
        .admin-day {
            min-height: 80px; /* æ‹‰é«˜æ ¼å­ä»¥å®¹ç´æ–‡å­— */
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* é å·¦å°é½Š */
            justify-content: flex-start; /* é ä¸Šå°é½Š */
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.75rem; 
            border: 1px solid #eee;
            background-color: #fff;
            position: relative;
            padding: 4px;
            overflow: hidden;
        }
        .admin-day.selected { border: 2px solid #333; background-color: #fafafa; }
        .admin-day.status-off { background-color: #f3f4f6; color: #9ca3af; } 
        .admin-day.status-on { background-color: #ffffff; color: #333; border-color: #e5e7eb; } 
        .admin-day.status-past { opacity: 0.4; background-color: #f9fafb; }

        .indicator-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; top: 6px; right: 6px; }
        
        .rule-box {
            background-color: #f9fafb;
            border-radius: 16px;
            padding: 12px;
            font-size: 0.75rem;
            color: #666;
            margin-top: 8px;
            line-height: 1.6;
        }

        /* Counter Button Styles */
        .counter-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 12px;
        }
        .counter-btn:active { background-color: #d1d5db; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Admin Slot Buttons */
        .admin-slot {
            font-size: 0.7rem; padding: 4px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 48px;
        }
        .admin-slot.locked { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .admin-slot.open { background-color: #fff; color: #333; border-color: #ddd; }
        
        /* Loading Overlay */
        #global-loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.3s;
        }
    </style>
</head>
<body class="bg-white pb-40">

    <!-- Loading Screen -->
    <div id="global-loading" style="display: none;">
        <div class="w-8 h-8 border-4 border-gray-300 border-t-gray-800 rounded-full animate-spin"></div>
        <p class="mt-2 text-xs text-gray-500 font-bold">è¼‰å…¥ä¸­...</p>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-8">
        <h1 class="text-2xl font-bold tracking-widest text-gray-800 mb-2">NAIL COLLECTOR</h1>
        <p class="text-gray-400 text-sm mb-12">æ”¶è—å®¶é ç´„ç³»çµ±</p>
        
        <div id="login-customer-view" class="w-full max-w-xs flex flex-col items-center gap-4 fade-in">
            <!-- LINE Login Button -->
            <button id="btn-line-login" onclick="loginWithLine()" class="w-full bg-[#06C755] text-white py-4 rounded-custom font-bold flex items-center justify-center gap-3 shadow-md hover:bg-[#05b54d] transition">
                <i class="fab fa-line text-xl"></i> ä½¿ç”¨ LINE ç™»å…¥
            </button>
            <!-- Fallback Guest Login -->
            <button onclick="mockLoginCustomer()" class="text-xs text-gray-400 border-b border-gray-200 pb-1">è¨ªå®¢ç›´æ¥é€²å…¥ (æ¸¬è©¦ç”¨)</button>
            
            <div class="mt-8"></div>
            <button onclick="toggleAdminLogin(true)" class="text-xs text-gray-400 border-b border-gray-200 pb-1">ç®¡ç†å“¡å¾Œå°ç™»å…¥</button>
        </div>

        <div id="login-admin-view" class="w-full max-w-xs flex flex-col items-center gap-3 hidden fade-in">
            <h2 class="text-gray-800 font-bold mb-2">å¾Œå°ç™»å…¥</h2>
            <input id="admin-id" type="text" placeholder="å¸³è™Ÿ (admin)" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm outline-none">
            <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼ (1234)" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm outline-none">
            <button onclick="doAdminLogin()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-md mt-2">ç™»å…¥ç³»çµ±</button>
            <button onclick="toggleAdminLogin(false)" class="text-xs text-gray-400 mt-2">è¿”å›é¡§å®¢å…¥å£</button>
        </div>
        <p class="text-[10px] text-gray-300 mt-12 text-center absolute bottom-10">System by Nail Collector</p>
    </div>

    <!-- =========================== -->
    <!-- Admin Panel -->
    <!-- =========================== -->
    <div id="admin-panel" class="hidden fixed inset-0 z-40 bg-gray-50 flex justify-center items-center">
        <!-- æ”¹ç‚º flex-col ä½ˆå±€ï¼Œè®“ header/footer å›ºå®šï¼Œä¸­é–“æ²å‹• -->
        <div class="w-full max-w-md bg-gray-50 h-full shadow-2xl flex flex-col relative">
            
            <!-- Header (å›ºå®šåœ¨é ‚éƒ¨) -->
            <div class="bg-white p-5 shadow-sm flex justify-between items-center border-b border-gray-100 flex-none z-10">
                <div>
                    <h2 class="text-base font-bold text-gray-800">ğŸ“… æ’ç¨‹ç®¡ç†</h2>
                    <p id="admin-month-title" class="text-[10px] text-gray-400"></p>
                </div>
                <button onclick="logout()" class="text-xs text-red-500 border border-red-200 px-3 py-1 rounded-full">ç™»å‡º</button>
            </div>

            <!-- Content (ä¸­é–“å¯æ²å‹•å€åŸŸ) -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-gray-100">
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        <div class="text-[10px] text-red-400 font-bold">æ—¥</div>
                        <div class="text-[10px] text-gray-400">ä¸€</div><div class="text-[10px] text-gray-400">äºŒ</div>
                        <div class="text-[10px] text-gray-400">ä¸‰</div><div class="text-[10px] text-gray-400">å››</div>
                        <div class="text-[10px] text-gray-400">äº”</div><div class="text-[10px] text-blue-400 font-bold">å…­</div>
                    </div>
                    <div id="admin-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>

                <div id="admin-edit-area" class="hidden fade-in">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase">ç·¨è¼¯æ—¥æœŸ</p>
                                <h3 id="admin-edit-date-title" class="text-lg font-bold text-gray-800"></h3>
                            </div>
                            <button id="admin-status-toggle" onclick="toggleAdminDateStatus()" class="px-3 py-1.5 rounded-full text-xs font-bold transition-colors shadow-sm">ç‹€æ…‹åˆ‡æ›</button>
                        </div>
                        <hr class="border-gray-100 mb-3">
                        <p class="text-[10px] text-gray-400 mb-2">é»æ“Šæ™‚æ®µä»¥ é–å®š/é–‹æ”¾ï¼š</p>
                        <div id="admin-slots-container" class="grid grid-cols-2 gap-2">
                            <!-- ç®¡ç†å€ slot -->
                        </div>
                    </div>
                </div>
                <div id="admin-no-selection" class="text-center text-gray-400 text-xs py-10 opacity-60">ğŸ‘† é»é¸ä¸Šæ–¹æœˆæ›†é–‹å§‹ç·¨è¼¯</div>
                
                <!-- åº•éƒ¨ç·©è¡ç©ºé–“ -->
                <div class="h-4"></div>
            </div>

            <!-- Footer (å›ºå®šåœ¨åº•éƒ¨) -->
            <div class="bg-white p-4 border-t border-gray-100 flex-none z-10">
                <button onclick="saveAdminSettings()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold shadow-lg text-sm hover:bg-gray-700 transition">å„²å­˜è¨­å®šä¸¦è¿”å›</button>
            </div>
        </div>
    </div>


    <!-- =========================== -->
    <!-- Customer App -->
    <!-- =========================== -->
    <main id="main-app" class="max-w-md mx-auto p-4 hidden">
        <header class="flex items-center justify-between py-6 mb-4">
            <div>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest">æ­¡è¿å›ä¾†ï¼Œ</p>
                <h2 id="user-name" class="text-lg font-bold text-gray-800">æ”¶è—å®¶ Guest</h2>
            </div>
            <button onclick="logout()" class="text-xs text-gray-400 underline">ç™»å‡º</button>
        </header>

        <!-- (01 Design Section) -->
        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase flex items-center">
                <span class="w-4 h-[1px] bg-gray-300 mr-2"></span> 01 / Design é€ å‹é …ç›® (å–®é¸)
            </h2>
            <div class="grid grid-cols-1 gap-2">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectSingleOption(this, 1000, 'design')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">é€æ˜ $1000</button>
                    <button onclick="selectSingleOption(this, 1200, 'design')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">å–®è‰² $1200</button>
                    <button onclick="selectSingleOption(this, 1300, 'design')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">è²“çœ¼ $1300</button>
                    <button onclick="selectSingleOption(this, 1400, 'design')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">æ¼¸å±¤ $1400</button>
                    <button onclick="selectSingleOption(this, 1400, 'design')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">é¡é¢ $1400</button>
                    <button onclick="selectSingleOption(this, 100, 'design')" class="btn-toggle p-4 text-xs rounded-custom" data-group="design">ç„¡é™è·³ç´”è‰² +$100</button>
                </div>

                <button onclick="selectSingleOption(this, 1550, 'design'); toggleDesignRule('rule-5', this)" class="btn-toggle mt-2 p-4 text-sm rounded-custom flex justify-between items-center" data-group="design">
                    <span>äº”æŒ‡é€ å‹</span><span>$1550 up</span>
                </button>
                <div id="rule-5" class="hidden rule-box border-l-2 border-gray-300"><p class="font-bold text-gray-700 mb-1">ã€äº”æŒ‡é€ å‹è¦å‰‡ã€‘</p><p>â€¢ 4-6æŒ‡ç‚ºé€ å‹æ¬¾å¼ + 4-6æŒ‡å–®è‰²</p></div>

                <button onclick="selectSingleOption(this, 1650, 'design'); toggleDesignRule('rule-10', this)" class="btn-toggle p-4 text-sm rounded-custom flex justify-between items-center" data-group="design">
                    <span>åæŒ‡é€ å‹</span><span>$1650 up</span>
                </button>
                <div id="rule-10" class="hidden rule-box border-l-2 border-gray-300"><p class="font-bold text-gray-700 mb-1">ã€åæŒ‡é€ å‹è¦å‰‡ã€‘</p><p>â€¢ 10æŒ‡çš†ç‚ºé€ å‹æ¬¾å¼</p></div>

                <button onclick="selectSingleOption(this, 1450, 'design'); toggleDesignRule('rule-any', this)" class="btn-toggle p-4 text-sm rounded-custom border-2 border-gray-200 flex justify-between items-center" data-group="design">
                    <span>âœ¨ ä»»æˆ‘åš (ç†±é–€)</span><span>$1450</span>
                </button>
                <div id="rule-any" class="hidden rule-box bg-gray-800 text-gray-100"><p class="font-bold mb-1">ã€ä»»æˆ‘åšè¦å‰‡ã€‘</p><p>å‘Šè¨´æˆ‘ã€Œ2å€‹é—œéµå­—ã€ä»»æˆ‘ç™¼æ®ã€‚ä¸æ¥å—ç¾ç”²ç…§ã€‚</p></div>
            </div>
        </section>

        <!-- (02 Removal Section) -->
        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase flex items-center">
                <span class="w-4 h-[1px] bg-gray-300 mr-2"></span> 02 / Removal å¸ç”² (å–®é¸)
            </h2>
            <div class="space-y-2">
                <button onclick="selectSingleOption(this, 0, 'removal')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal">
                    <span>ç„¡é ˆå¸ç”²</span><span>$0</span>
                </button>
                <button onclick="selectSingleOption(this, 200, 'removal')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal">
                    <span>æœ¬åº—å¸ç”²çºŒä½œ</span><span>$200</span>
                </button>
                <button onclick="selectSingleOption(this, 400, 'removal')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal">
                    <span>ä»–åº—å¸ç”²çºŒä½œ</span><span>$400</span>
                </button>
                <button onclick="selectSingleOption(this, 500, 'removal')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal">
                    <span>ç´”å¸ç”² (ä¸çºŒä½œ)</span><span>$500</span>
                </button>
            </div>

            <!-- åŠ è³¼é …ç›® (å¤§é‘½æ”¹ç‚ºè¨ˆæ•¸å™¨) -->
            <div class="mt-4 bg-gray-50 p-4 rounded-custom border border-gray-100">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-600">åŠ è³¼é …ç›®</span>
                </div>
                
                <!-- å¤§é‘½è¨ˆæ•¸å™¨ -->
                <div class="flex justify-between items-center mb-3 bg-white p-3 rounded-xl border border-gray-200">
                    <span class="text-xs text-gray-700">ä»–åº—å¤§é‘½/å‡¹å‡¸ ($50/æŒ‡)</span>
                    <div class="flex items-center gap-3">
                        <button onclick="updateDiamondCount(-1)" class="counter-btn"><i class="fas fa-minus"></i></button>
                        <span id="diamond-count" class="text-sm font-bold w-4 text-center">0</span>
                        <button onclick="updateDiamondCount(1)" class="counter-btn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                
                <!-- å…¶ä»–åŠ è³¼ -->
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="toggleService(this, 50)" class="btn-toggle p-3 text-xs rounded-custom text-left pl-4">å¸æŒ‡ç”²æ²¹ +$50</button>
                </div>
            </div>
        </section>

        <!-- (03 Care Section) -->
        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase flex items-center">
                <span class="w-4 h-[1px] bg-gray-300 mr-2"></span> 03 / Care ä¿é¤Š & ä¿®è£œ
            </h2>
            <div class="grid grid-cols-1 gap-2">
                <button onclick="toggleService(this, 400)" class="btn-toggle p-4 text-sm rounded-custom flex justify-between"><span>åŸºç¤ä¿é¤Š</span><span>$400</span></button>
            </div>
            
            <div class="mt-4 space-y-3">
                <!-- å»¶ç”²è¨ˆæ•¸å™¨ -->
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <span class="text-xs text-gray-700 font-bold">å»¶ç”² ($150/æŒ‡)</span>
                    <div class="flex items-center gap-3">
                        <button onclick="updateExtensionCount(-1)" class="counter-btn"><i class="fas fa-minus"></i></button>
                        <span id="ext-count" class="text-sm font-bold w-4 text-center">0</span>
                        <button onclick="updateExtensionCount(1)" class="counter-btn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <!-- è£œç”²è¨ˆæ•¸å™¨ -->
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <span class="text-xs text-gray-700 font-bold">è£œç”² ($50/æŒ‡)</span>
                    <div class="flex items-center gap-3">
                        <button onclick="updateRepairCount(-1)" class="counter-btn"><i class="fas fa-minus"></i></button>
                        <span id="repair-count" class="text-sm font-bold w-4 text-center">0</span>
                        <button onclick="updateRepairCount(1)" class="counter-btn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <!-- (04 Calendar Section) -->
        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase flex items-center">
                <span class="w-4 h-[1px] bg-gray-300 mr-2"></span> 04 / Schedule æ™‚é–“
            </h2>
            <div class="bg-gray-50 p-6 rounded-custom">
                <div class="flex justify-between items-end mb-4 px-1">
                    <h3 id="calendar-title" class="text-xl font-bold text-gray-800 tracking-wide"></h3>
                    <span class="text-[10px] text-gray-400">â— Available</span>
                </div>
                <div class="grid grid-cols-7 gap-2 mb-2 text-center">
                    <div class="text-[10px] text-red-400 font-bold">SUN</div>
                    <div class="text-[10px] text-gray-400">MON</div><div class="text-[10px] text-gray-400">TUE</div>
                    <div class="text-[10px] text-gray-400">WED</div><div class="text-[10px] text-gray-400">THU</div>
                    <div class="text-[10px] text-gray-400">FRI</div><div class="text-[10px] text-blue-400 font-bold">SAT</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 mb-6"></div>
                <div id="time-slots-container" class="hidden border-t border-gray-200 pt-4 fade-in">
                    <p class="text-[10px] text-gray-400 mb-3 text-center tracking-widest uppercase mt-4">è«‹é¸æ“‡é–‹å§‹æ™‚é–“ (æœå‹™ç´„ 2.5 å°æ™‚)</p>
                    <div id="time-slots-grid" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>
        </section>

        <!-- Terms -->
        <section class="bg-gray-50 p-6 rounded-custom border border-gray-100 mb-10">
            <h3 class="text-sm font-bold text-gray-800 mb-4 tracking-widest">ã€é¦–æ¬¡å…‰è‡¨å…¥å ´é–€ç¥¨ğŸŸï¸ã€‘</h3>
            <p class="text-[11px] text-gray-500 mb-4">é¦–æ¬¡é ç´„æ”¶å– <span class="text-gray-900 font-bold">$500é ç´„é–€ç¥¨</span>ï¼Œ24å°æ™‚å…§åŒ¯æ¬¾ä¿ç•™ã€‚</p>
            <label class="mt-2 flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="term-check" onchange="validate()" class="mt-1 w-4 h-4 accent-gray-600">
                <span class="text-xs text-gray-600">æˆ‘å·²è©³ç´°é–±è®€ä¸¦åŒæ„é–€ç¥¨è¦ç¯„</span>
            </label>
        </section>

        <!-- Bottom Bar -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-gray-100 p-5 z-40">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div>
                    <p class="text-[9px] text-gray-400 uppercase tracking-widest">é ä¼°é‡‘é¡</p>
                    <p class="text-xl font-bold text-gray-800">$<span id="price-display">0</span></p>
                </div>
                <button id="submit-btn" disabled onclick="finalSubmit()" 
                    class="bg-gray-200 text-white px-12 py-4 rounded-custom font-bold text-sm transition-all shadow-sm opacity-50">
                    é€å‡ºé ç´„
                </button>
            </div>
        </footer>

    </main>

    <script>
        // ==========================================
        // ã€SUPABASE è¨­å®šå€ã€‘
        // ==========================================
        const SUPABASE_URL = 'https://alkuncpbqslksxeorndz.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsa3VuY3BicXNsa3N4ZW9ybmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzg0MjIsImV4cCI6MjA4MjkxNDQyMn0.Q-HxirPEavixO-tW6hRp6Rz6fFLrWMqfCU3kEKcrRAg';
        
        // ==========================================
        // ã€LINE LIFF è¨­å®šå€ã€‘
        // è«‹å¡«å…¥æ‚¨çš„ LIFF ID
        // ==========================================
        const LIFF_ID = 'YOUR_LIFF_ID_HERE'; 

        let supabaseClient = null;
        if (typeof supabase !== 'undefined' && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
             supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // ==========================================
        // ã€æ ¸å¿ƒé‚è¼¯ã€‘
        // ==========================================
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth(); 
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const allTimeSlots = ['09:30', '12:00', '14:30', '17:00', '19:30'];
        
        let calendarData = []; 
        let adminSelectedIndex = null; 
        
        // Price Tracking
        let priceState = {
            design: 0,
            removal: 0,
            extras: 0 
        };
        let diamondCount = 0;
        let extensionCount = 0;
        let repairCount = 0;
        
        let selectedDate = null;
        let selectedTime = null;
        let userProfile = null; // Store LINE profile

        // Global functions
        window.mockLoginCustomer = mockLoginCustomer;
        window.loginWithLine = loginWithLine; // New
        window.toggleAdminLogin = toggleAdminLogin;
        window.doAdminLogin = doAdminLogin;
        window.logout = logout;
        window.toggleService = toggleService;
        window.selectSingleOption = selectSingleOption; 
        window.toggleDesignRule = toggleDesignRule;
        window.updateDiamondCount = updateDiamondCount;
        window.updateExtensionCount = updateExtensionCount;
        window.updateRepairCount = updateRepairCount;
        window.validate = validate;
        window.finalSubmit = finalSubmit;
        window.saveAdminSettings = saveAdminSettings;
        window.toggleAdminDateStatus = toggleAdminDateStatus;
        window.toggleAdminSlot = toggleAdminSlot; // Make sure this is exposed

        window.onload = async function() {
            // Initialize LINE LIFF
            if (LIFF_ID && LIFF_ID !== 'YOUR_LIFF_ID_HERE') {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        userProfile = profile;
                        // Auto login to main app
                        document.getElementById('login-overlay').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        document.getElementById('user-name').innerText = profile.displayName;
                    }
                } catch (err) {
                    console.error('LIFF Init Error', err);
                }
            }

            if (!supabaseClient) {
                console.warn("Supabase not configured, using offline mode.");
                initMockData(); 
            } else {
                await fetchCalendarDataWithTimeout();
            }
            renderCalendar();
            document.getElementById('calendar-title').innerText = `${monthNames[currentMonth]} ${currentYear}`;
            document.getElementById('admin-month-title').innerText = `${currentYear} å¹´ ${currentMonth + 1} æœˆ`;
        };

        // --- LINE Login ---
        async function loginWithLine() {
            if (!LIFF_ID || LIFF_ID === 'YOUR_LIFF_ID_HERE') {
                alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š LIFF ID");
                return;
            }
            if (!liff.isLoggedIn()) {
                liff.login(); // This will redirect to LINE Login
            }
        }

        // --- Pricing Logic ---

        function calculateTotal() {
            let total = priceState.design + priceState.removal + priceState.extras;
            total += (diamondCount * 50);
            total += (extensionCount * 150);
            total += (repairCount * 50);
            return total;
        }

        function updateUI() {
            const total = calculateTotal();
            document.getElementById('price-display').innerText = total;
            validate();
        }

        function selectSingleOption(el, price, groupName) {
            const groupButtons = document.querySelectorAll(`button[data-group="${groupName}"]`);
            
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                priceState[groupName] = 0;
                if (groupName === 'design') document.querySelectorAll('.rule-box').forEach(b => b.classList.add('hidden'));
            } else {
                groupButtons.forEach(btn => btn.classList.remove('active'));
                if (groupName === 'design') document.querySelectorAll('.rule-box').forEach(b => b.classList.add('hidden'));
                el.classList.add('active');
                priceState[groupName] = price;
            }
            updateUI();
        }

        function toggleService(el, price) {
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                priceState.extras -= price;
            } else {
                el.classList.add('active');
                priceState.extras += price;
            }
            updateUI();
        }

        function toggleDesignRule(ruleId, el) {
            const ruleEl = document.getElementById(ruleId);
            if (el.classList.contains('active')) ruleEl.classList.remove('hidden');
            else ruleEl.classList.add('hidden');
        }

        // Counters
        function updateDiamondCount(change) {
            const newCount = diamondCount + change;
            if (newCount < 0) return;
            diamondCount = newCount;
            document.getElementById('diamond-count').innerText = diamondCount;
            updateUI();
        }

        function updateExtensionCount(change) {
            const newCount = extensionCount + change;
            if (newCount < 0) return;
            extensionCount = newCount;
            document.getElementById('ext-count').innerText = extensionCount;
            updateUI();
        }

        function updateRepairCount(change) {
            const newCount = repairCount + change;
            if (newCount < 0) return;
            repairCount = newCount;
            document.getElementById('repair-count').innerText = repairCount;
            updateUI();
        }

        // --- Database Logic ---
        
        async function fetchCalendarDataWithTimeout() {
            showLoading(true, "æ­£åœ¨é€£ç·šè³‡æ–™åº«...");
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
            try {
                await Promise.race([fetchCalendarData(), timeoutPromise]);
                console.log("Connection successful!");
            } catch (err) {
                console.error("Error:", err);
                initMockData(); 
            } finally {
                showLoading(false);
            }
        }

        async function fetchCalendarData() {
            const { data, error } = await supabaseClient.from('calendar_slots').select('*');
            if (error) throw new Error(error.message);
            initMockData(true); 
            data.forEach(row => {
                const parts = row.date_id.split('-');
                if (parseInt(parts[0]) === currentYear && parseInt(parts[1]) === currentMonth) {
                    const dateNum = parseInt(parts[2]);
                    if (calendarData[dateNum - 1]) {
                        calendarData[dateNum - 1].status = row.status;
                        calendarData[dateNum - 1].bookedSlots = row.booked_slots || [];
                    }
                }
            });
        }

        function initMockData(onlyStructure = false) {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            calendarData = [];
            for (let i = 1; i <= daysInMonth; i++) {
                let isPast = (currentMonth === today.getMonth() && i < today.getDate());
                let status = isPast ? 'past' : 'available';
                let bookedSlots = [];
                if (!onlyStructure && !isPast) {
                    // å‡è³‡æ–™ä¸ç”¨è‡ªå‹•ç”¢ç”Ÿ bookedï¼Œä¿æŒç©ºç™½æ–¹ä¾¿æ¸¬è©¦
                }
                calendarData.push({ date: i, status: status, bookedSlots: bookedSlots });
            }
        }

        // --- Auth & Admin UI ---

        function showLoading(show, text) {
            const el = document.getElementById('global-loading');
            if (text) el.querySelector('p').innerText = text;
            
            // Bypass Tailwind to force display
            el.style.display = show ? 'flex' : 'none';
        }

        function mockLoginCustomer() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function toggleAdminLogin(show) {
            document.getElementById('login-customer-view').classList.toggle('hidden', show);
            document.getElementById('login-admin-view').classList.toggle('hidden', !show);
        }

        function doAdminLogin() {
            const id = document.getElementById('admin-id').value;
            const pwd = document.getElementById('admin-pwd').value;
            if(id === 'admin' && pwd === '1234') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                // Force flex display
                document.getElementById('admin-panel').style.display = 'flex';
                renderAdminCalendar();
            } else {
                alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼(é è¨­: admin / 1234)');
            }
        }

        function logout() { 
            try {
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    liff.logout();
                }
            } catch (e) {
                console.warn("LIFF logout failed", e);
            }
            location.reload(); 
        }

        function renderAdminCalendar() {
            const grid = document.getElementById('admin-calendar-grid');
            grid.innerHTML = ''; 
            const firstDayIndex = new Date(currentYear, currentMonth, 1).getDay();
            for(let i=0; i<firstDayIndex; i++) grid.appendChild(document.createElement('div'));

            calendarData.forEach((item, index) => {
                const dayDiv = document.createElement('div');
                
                let dayText = `<span class="text-sm font-bold text-gray-500">${item.date}</span>`;
                
                // --- NEW: List slots inside cell ---
                if (item.bookedSlots.length > 0) {
                    dayText += `<div class="w-full mt-1 flex flex-col gap-1 overflow-hidden">`;
                    item.bookedSlots.forEach(slot => {
                        const time = (typeof slot === 'string') ? slot : slot.time;
                        const user = (typeof slot === 'string') ? 'Admin' : slot.user;
                        // Shorten user name if too long
                        const shortUser = user.length > 3 ? user.substring(0,2)+'..' : user;
                        
                        dayText += `
                            <div class="text-[9px] bg-red-50 text-red-700 px-1 rounded truncate leading-tight border border-red-100">
                                ${time} ${shortUser}
                            </div>
                        `;
                    });
                    dayText += `</div>`;
                }
                
                dayDiv.innerHTML = dayText;
                // ------------------------------------

                let className = "admin-day";
                if(item.status === 'past') className += " status-past";
                else if(item.status === 'booked') className += " status-off";
                else className += " status-on";
                if(index === adminSelectedIndex) className += " selected";
                dayDiv.className = className;
                dayDiv.onclick = () => selectAdminDate(index);
                
                // Dot indicator only if completely open (no bookings)
                if(item.status === 'available' && item.bookedSlots.length === 0) {
                   const dot = document.createElement('div');
                   dot.className = "indicator-dot bg-green-400";
                   dayDiv.appendChild(dot);
                }
                grid.appendChild(dayDiv);
            });
        }

        function selectAdminDate(index) {
            adminSelectedIndex = index;
            renderAdminCalendar();
            const item = calendarData[index];
            document.getElementById('admin-no-selection').classList.add('hidden');
            document.getElementById('admin-edit-area').classList.remove('hidden');
            document.getElementById('admin-edit-date-title').innerText = `${currentMonth+1}æœˆ${item.date}æ—¥`;
            
            const btn = document.getElementById('admin-status-toggle');
            if (item.status === 'available') {
                btn.innerText = "ğŸŸ¢ ç‡Ÿæ¥­ä¸­";
                btn.className = "px-4 py-2 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200 w-full";
            } else if (item.status === 'booked') {
                btn.innerText = "âšª å…¬ä¼‘/åœæ¥­";
                btn.className = "px-4 py-2 rounded-full text-xs font-bold bg-gray-100 text-gray-500 border border-gray-200 w-full";
            } else {
                btn.innerText = "âš« å·²éæœŸ";
                btn.className = "px-4 py-2 rounded-full text-xs font-bold bg-gray-100 text-gray-300 border border-gray-200 w-full cursor-not-allowed";
                btn.disabled = true;
            }

            const slotsContainer = document.getElementById('admin-slots-container');
            slotsContainer.innerHTML = '';
            if(item.status === 'available') {
                allTimeSlots.forEach(time => {
                    // Check if booked (handle string or object)
                    const booking = item.bookedSlots.find(slot => (typeof slot === 'string' ? slot : slot.time) === time);
                    const isBooked = !!booking;
                    const bookerName = isBooked ? (typeof booking === 'string' ? 'Admin' : booking.user) : '';
                    
                    const slotBtn = document.createElement('button');
                    // é¡¯ç¤ºæ ¼å¼ï¼š12:00 (æ›è¡Œ) â›” å°æ˜
                    slotBtn.innerHTML = `
                        <div class="flex flex-col items-center leading-tight">
                            <span class="font-bold text-sm">${time}</span>
                            <span class="text-[10px] ${isBooked ? 'text-red-600 font-bold' : 'text-green-600'}">
                                ${isBooked ? 'â›” ' + bookerName : 'â­• é–‹æ”¾'}
                            </span>
                        </div>
                    `;
                    slotBtn.className = isBooked ? "admin-slot locked" : "admin-slot open";
                    slotBtn.onclick = () => toggleAdminSlot(index, time);
                    slotsContainer.appendChild(slotBtn);
                });
            } else {
                slotsContainer.innerHTML = '<p class="col-span-2 text-center text-xs text-gray-400 py-2">æœ¬æ—¥æœªé–‹æ”¾</p>';
            }
        }

        function toggleAdminDateStatus() {
            if (adminSelectedIndex === null) return;
            const item = calendarData[adminSelectedIndex];
            if (item.status === 'past') return;
            item.status = (item.status === 'available') ? 'booked' : 'available';
            if (!item.bookedSlots) item.bookedSlots = [];
            selectAdminDate(adminSelectedIndex); 
        }

        function toggleAdminSlot(index, time) {
            // Find existing booking
            const bookedIndex = calendarData[index].bookedSlots.findIndex(s => (typeof s === 'string' ? s : s.time) === time);
            
            if (bookedIndex >= 0) {
                // Remove (Unblock)
                calendarData[index].bookedSlots.splice(bookedIndex, 1);
            } else {
                // Add (Block manually)
                calendarData[index].bookedSlots.push({ time: time, user: 'Admin' });
            }
            selectAdminDate(index);
        }

        async function saveAdminSettings() {
            if (!supabaseClient) {
                alert('æœªè¨­å®š Supabaseï¼Œåƒ…æ›´æ–°å‰ç«¯æš«å­˜ã€‚');
                logout(); return;
            }
            showLoading(true, "æ­£åœ¨å„²å­˜...");
            try {
                // Bulk Upsert - faster
                const updates = calendarData.map(item => ({
                    date_id: `${currentYear}-${currentMonth}-${item.date}`,
                    status: item.status,
                    booked_slots: item.bookedSlots
                }));

                const { error } = await supabaseClient.from('calendar_slots').upsert(updates);
                if (error) throw error;

                alert('è¨­å®šå·²åŒæ­¥è‡³é›²ç«¯è³‡æ–™åº«ï¼');
                logout(); // Force reload
            } catch (err) {
                alert('å„²å­˜å¤±æ•—ï¼š' + err.message);
                showLoading(false); // Only hide on error
            }
        }

        // --- Customer App Logic ---

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = ''; 
            const firstDayIndex = new Date(currentYear, currentMonth, 1).getDay();
            for(let i=0; i<firstDayIndex; i++) grid.appendChild(document.createElement('div'));

            calendarData.forEach(item => {
                const dayDiv = document.createElement('div');
                dayDiv.innerText = item.date;
                dayDiv.className = `calendar-day ${item.status}`;
                if (item.status === 'available') dayDiv.onclick = () => selectDate(dayDiv, item.date, item.bookedSlots);
                grid.appendChild(dayDiv);
            });
        }

        function selectDate(el, dateNum, bookedSlots) {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            selectedDate = `${currentMonth + 1}/${dateNum}`;
            selectedTime = null; 
            renderTimeSlots(bookedSlots);
            validate();
        }

        function renderTimeSlots(bookedSlots) {
            const container = document.getElementById('time-slots-container');
            const grid = document.getElementById('time-slots-grid');
            container.classList.remove('hidden');
            grid.innerHTML = ''; 
            let availableCount = 0;
            allTimeSlots.forEach(time => {
                // Check booking (string or object)
                const isBooked = bookedSlots && bookedSlots.some(slot => (typeof slot === 'string' ? slot : slot.time) === time);
                
                if (isBooked) return; 
                
                const btn = document.createElement('button');
                btn.className = 'btn-toggle p-3 text-sm rounded-custom w-full';
                btn.innerText = time;
                btn.onclick = () => selectTime(btn, time);
                grid.appendChild(btn);
                availableCount++;
            });
            if (availableCount === 0) grid.innerHTML = '<p class="text-xs text-gray-400 col-span-2 text-center py-2">æœ¬æ—¥é ç´„å·²æ»¿</p>';
        }

        function selectTime(el, time) {
            document.querySelectorAll('#time-slots-grid button').forEach(b => b.classList.remove('active', 'bg-gray-800', 'text-white'));
            el.classList.add('active'); 
            selectedTime = time;
            validate();
        }

        function validate() {
            const check = document.getElementById('term-check').checked;
            const total = calculateTotal();
            const isValid = check && selectedDate && selectedTime && total > 0;
            const btn = document.getElementById('submit-btn');
            
            if (isValid) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'bg-gray-200', 'text-white');
                btn.classList.add('bg-gray-800', 'text-white', 'shadow-lg');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'bg-gray-200', 'text-white');
                btn.classList.remove('bg-gray-800', 'shadow-lg');
            }
        }

        async function finalSubmit() {
            if (!supabaseClient) {
                alert(`(å‡è³‡æ–™æ¨¡å¼) é ç´„æˆåŠŸï¼\n\n${selectedDate} ${selectedTime} \né‡‘é¡ $${calculateTotal()}`);
                return;
            }
            showLoading(true, "æ­£åœ¨é€å‡ºé ç´„...");
            try {
                const dateParts = selectedDate.split('/');
                const dateId = `${currentYear}-${currentMonth}-${dateParts[1]}`;
                
                // 1. Get latest data to prevent conflict
                const { data } = await supabaseClient.from('calendar_slots').select('*').eq('date_id', dateId).single();
                let currentBooked = data ? (data.booked_slots || []) : [];
                
                // 2. Check conflict
                if (currentBooked.some(slot => (typeof slot === 'string' ? slot : slot.time) === selectedTime)) {
                    alert('å“å‘€ï¼é€™å€‹æ™‚æ®µå‰›å‰›è¢«ç´„èµ°äº†ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚æ®µã€‚');
                    window.location.reload(); return;
                }
                
                // 3. Add booking with Name
                let userName = "Guest";
                if(userProfile) userName = userProfile.displayName;
                currentBooked.push({ time: selectedTime, user: userName });

                const { error } = await supabaseClient.from('calendar_slots').upsert({ 
                    date_id: dateId, booked_slots: currentBooked, status: 'available'
                });
                if (error) throw error;
                
                alert(`é ç´„æˆåŠŸï¼\n\né ç´„äººï¼š${userName}\næ—¥æœŸï¼š${selectedDate}\næ™‚é–“ï¼š${selectedTime}\né‡‘é¡ï¼š$${calculateTotal()}\n\nè³‡æ–™å·²å¯«å…¥è³‡æ–™åº«ã€‚`);
                window.location.reload();
            } catch(err) {
                alert("é ç´„å¤±æ•—ï¼š" + err.message);
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nail Collector | é ç´„ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; color: #333; -webkit-tap-highlight-color: transparent; }
        .rounded-custom { border-radius: 24px; }
        .btn-toggle { transition: all 0.2s; background-color: #fff; color: #666; border: 1px solid #e5e7eb; }
        .btn-toggle.active { background-color: #374151; color: #fff; border-color: #374151; }
        .calendar-day { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; font-size: 0.8rem; position: relative; background: #fff; }
        .calendar-day.selected { background-color: #374151; color: #fff; }
        .calendar-day.booked { background-color: #f3f4f6; color: #d1d5db; }
        .calendar-day.not-open { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; position: relative; }
        .calendar-day.not-open::after { content: 'æœªé–‹æ”¾'; position: absolute; bottom: 2px; font-size: 7px; color: #6b7280; }
        .calendar-day.closed { background-color: #fee2e2; color: #dc2626; cursor: not-allowed; text-decoration: line-through; }
        .admin-day { min-height: 80px; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start; cursor: pointer; border-radius: 8px; font-size: 0.75rem; border: 1px solid #eee; background-color: #fff; position: relative; padding: 4px; overflow: hidden; }
        .admin-day.selected { border: 2px solid #333; background-color: #fafafa; }
        .admin-day.status-off { background-color: #f3f4f6; color: #9ca3af; }
        .admin-day.status-past { opacity: 0.5; background-color: #f9fafb; }
        .admin-day.has-pending { border: 2px solid #fbbf24; background-color: #fffbeb; }
        .booking-bar { width: 100%; margin-top: 2px; padding: 2px 4px; border-radius: 4px; font-size: 9px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .bar-confirmed { background-color: #dcfce7; color: #15803d; }
        .bar-pending { background-color: #fef3c7; color: #92400e; }
        .bar-pending-payment { background-color: #fed7aa; color: #9a3412; }
        .indicator-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; top: 6px; right: 6px; }
        .rule-box { background-color: #f9fafb; border-radius: 16px; padding: 12px; font-size: 0.75rem; color: #666; margin-top: 8px; line-height: 1.6; }
        .counter-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #e5e7eb; color: #4b5563; font-size: 12px; }
        .counter-btn:active { background-color: #d1d5db; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .schedule-item { display: flex; flex-direction: column; padding: 12px; background: white; border-radius: 12px; border: 1px solid #eee; margin-bottom: 8px; }
        .schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .schedule-actions { display: flex; gap: 8px; justify-content: flex-end; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .tag-pending { background: #fffbeb; color: #d97706; border: 1px solid #fcd34d; }
        .tag-pending-payment { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; }
        .tag-confirmed { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .tag-booked { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
        .tag-open { background: #ecfccb; color: #3f6212; border: 1px solid #d9f99d; }
        .admin-slot { font-size: 0.7rem; padding: 6px; border-radius: 6px; border: 1px solid #eee; cursor: pointer; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .admin-slot.locked { background-color: #fee2e2; color: #ef4444; border-color: #fecaca; }
        .admin-slot.open { background-color: #fff; color: #333; border-color: #ddd; }
        #global-loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.3s; }
    </style>
</head>
<body class="bg-white pb-40">
    <div id="global-loading" style="display: none;">
        <div class="w-8 h-8 border-4 border-gray-300 border-t-gray-800 rounded-full animate-spin"></div>
        <p class="mt-2 text-xs text-gray-500 font-bold">è¼‰å…¥ä¸­...</p>
    </div>

    <div id="login-overlay" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-8">
        <h1 class="text-2xl font-bold tracking-widest text-gray-800 mb-2">NAIL COLLECTOR</h1>
        <p class="text-gray-400 text-sm mb-12">æ”¶è—å®¶é ç´„ç³»çµ±</p>
        <div id="auto-login-hint" class="w-full max-w-xs mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
            <div class="flex items-center gap-2 text-blue-800 text-sm"><i class="fas fa-info-circle"></i><span>æ­£åœ¨è‡ªå‹•ç™»å…¥...</span></div>
        </div>
        <div id="login-customer-view" class="w-full max-w-xs flex flex-col items-center gap-4 fade-in">
            <button id="btn-line-login" onclick="window.loginWithLine()" class="w-full bg-[#06C755] text-white py-4 rounded-custom font-bold flex items-center justify-center gap-3 shadow-md hover:bg-[#05b54d] transition"><i class="fab fa-line text-xl"></i> ä½¿ç”¨ LINE ç™»å…¥é ç´„</button>
            <div class="mt-8"></div>
            <button onclick="window.toggleAdminLogin(true)" class="text-xs text-gray-400 border-b border-gray-200 pb-1">ç®¡ç†å“¡å¾Œå°ç™»å…¥</button>
        </div>
        <div id="login-admin-view" class="w-full max-w-xs flex flex-col items-center gap-3 hidden fade-in">
            <h2 class="text-gray-800 font-bold mb-2">å¾Œå°ç™»å…¥</h2>
            <input id="admin-id" type="text" placeholder="å¸³è™Ÿ (admin)" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm outline-none">
            <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼ (1234)" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm outline-none">
            <button onclick="window.doAdminLogin()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-md mt-2">ç™»å…¥ç³»çµ±</button>
            <button onclick="window.toggleAdminLogin(false)" class="text-xs text-gray-400 mt-2">è¿”å›é¡§å®¢å…¥å£</button>
        </div>
        <p class="text-[10px] text-gray-300 mt-12 text-center absolute bottom-10">System by Nail Collector</p>
    </div>

    <div id="admin-panel" class="hidden fixed inset-0 z-40 bg-gray-50 flex justify-center items-center">
        <div class="w-full max-w-md bg-gray-50 h-full shadow-2xl flex flex-col relative">
            <div class="bg-white p-5 shadow-sm flex justify-between items-center border-b border-gray-100 flex-none z-10">
                <div><h2 class="text-base font-bold text-gray-800">ğŸ“… å¾Œå°å¯©æ ¸ç®¡ç†</h2><p id="admin-month-title" class="text-[10px] text-gray-400"></p></div>
                <button onclick="window.logout()" class="text-xs text-red-500 border border-red-200 px-3 py-1 rounded-full">ç™»å‡º</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div class="bg-white p-3 rounded-xl shadow-sm mb-3 border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">ğŸ“… é–‹æ”¾è¨­å®š</h3>
                    <div class="text-[10px] text-gray-600 space-y-1">
                        <div class="flex justify-between items-center py-1 border-b border-gray-100">
                            <span>ç¬¬ä¸€æ¬¡é–‹æ”¾ï¼š</span>
                            <span class="font-bold text-blue-600">æ¯æœˆ 15 è™Ÿ 12:00</span>
                        </div>
                        <div class="flex justify-between items-center py-1 border-b border-gray-100">
                            <span>é–‹æ”¾ç¯„åœï¼š</span>
                            <span class="font-bold">ä¸‹å€‹æœˆ 1-15 è™Ÿ</span>
                        </div>
                        <div class="flex justify-between items-center py-1 border-b border-gray-100">
                            <span>ç¬¬äºŒæ¬¡é–‹æ”¾ï¼š</span>
                            <span class="font-bold text-blue-600">æ¯æœˆ 25 è™Ÿ 12:00</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span>é–‹æ”¾ç¯„åœï¼š</span>
                            <span class="font-bold">ä¸‹å€‹æœˆ 16-æœˆåº•</span>
                        </div>
                    </div>
                    <div id="closed-dates-list" class="mt-3 pt-3 border-t border-gray-100">
                        <p class="text-[10px] text-gray-500 mb-1">ğŸš« å·²é—œé–‰æ—¥æœŸï¼š</p>
                        <div id="closed-dates-items" class="text-[10px] text-red-600"></div>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-gray-100">
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center"><div class="text-[10px] text-red-400 font-bold">æ—¥</div><div class="text-[10px] text-gray-400">ä¸€</div><div class="text-[10px] text-gray-400">äºŒ</div><div class="text-[10px] text-gray-400">ä¸‰</div><div class="text-[10px] text-gray-400">å››</div><div class="text-[10px] text-gray-400">äº”</div><div class="text-[10px] text-blue-400 font-bold">å…­</div></div>
                    <div id="admin-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
                <div id="admin-edit-area" class="hidden fade-in">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <div><p class="text-[10px] text-gray-400 uppercase">ç·¨è¼¯æ—¥æœŸ</p><h3 id="admin-edit-date-title" class="text-lg font-bold text-gray-800"></h3></div>
                            <button id="admin-status-toggle" onclick="window.toggleAdminDateStatus()" class="px-3 py-1.5 rounded-full text-xs font-bold transition-colors shadow-sm bg-gray-100">ç‹€æ…‹åˆ‡æ›</button>
                        </div>
                        <div class="mb-3">
                            <button id="admin-close-date-btn" onclick="window.toggleDateClosed()" class="w-full px-3 py-2 rounded-lg text-xs font-bold transition-colors border-2">æ‰‹å‹•é—œé–‰æ­¤æ—¥æœŸ</button>
                            <p class="text-[9px] text-gray-400 mt-1 text-center">é—œé–‰å¾Œå®¢äººå°‡ç„¡æ³•é ç´„æ­¤æ—¥æœŸ</p>
                        </div>
                        <hr class="border-gray-100 mb-3"><p class="text-[10px] text-gray-400 mb-2">ç•¶æ—¥é ç´„æ¸…å–®ï¼š</p>
                        <div id="admin-schedule-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 border-t border-gray-100 flex-none z-10">
                <button onclick="window.saveAdminSettings()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold shadow-lg text-sm hover:bg-gray-700 transition">å„²å­˜è®Šæ›´ (å¿…é ˆé»æ“Š)</button>
            </div>
        </div>
    </div>

    <main id="main-app" class="max-w-md mx-auto p-4 hidden">
        <header class="flex items-center justify-between py-6 mb-4">
            <div>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest">æ­¡è¿å›ä¾†ï¼Œ</p>
                <h2 id="user-name" class="text-lg font-bold text-gray-800">æ”¶è—å®¶ Guest</h2>
                <p id="user-status" class="text-[10px] text-gray-500 mt-1"></p>
            </div>
            <button onclick="window.logout()" class="text-xs text-gray-400 underline">ç™»å‡º</button>
        </header>
        <div id="friend-warning" class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg hidden">
            <div class="flex items-start gap-3">
                <i class="fab fa-line text-green-600 text-2xl mt-0.5"></i>
                <div class="flex-1">
                    <p class="text-sm font-bold text-green-800 mb-1">ğŸ“± è«‹å…ˆåŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ</p>
                    <p class="text-xs text-green-700 mb-3">ç‚ºç¢ºä¿èƒ½å³æ™‚æ”¶åˆ°é ç´„é€šçŸ¥ï¼Œè«‹å…ˆåŠ å…¥æˆ‘å€‘ç‚ºå¥½å‹ï¼</p>
                    <button id="add-friend-btn" onclick="window.addFriend()" class="text-xs bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition shadow-sm"><i class="fab fa-line mr-1"></i> ç«‹å³åŠ å…¥å®˜æ–¹å¸³è™Ÿ</button>
                    <button onclick="window.recheckFriendship()" class="ml-2 text-xs text-green-600 underline">æˆ‘å·²åŠ å…¥ï¼Œé‡æ–°æª¢æŸ¥</button>
                </div>
            </div>
        </div>
        <div id="line-login-warning" class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg hidden">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-600 text-lg mt-0.5"></i>
                <div class="flex-1">
                    <p class="text-sm font-bold text-yellow-800 mb-1">å°šæœªä½¿ç”¨ LINE ç™»å…¥</p>
                    <p class="text-xs text-yellow-700 mb-3">æ‚¨ç›®å‰ç„¡æ³•é€å‡ºé ç´„ï¼Œè«‹å…ˆä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥ã€‚</p>
                    <button onclick="window.showLoginScreen()" class="text-xs bg-yellow-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-yellow-700 transition"><i class="fab fa-line mr-1"></i> å‰å¾€ LINE ç™»å…¥</button>
                </div>
            </div>
        </div>

        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase flex items-center"><span class="w-4 h-[1px] bg-gray-300 mr-2"></span> 01 / Design é€ å‹</h2>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <button onclick="window.selectSingleOption(this, 1000, 'design', 'é€æ˜')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">é€æ˜ $1000</button>
                <button onclick="window.selectSingleOption(this, 1200, 'design', 'å–®è‰²')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">å–®è‰² $1200</button>
                <button onclick="window.selectSingleOption(this, 1300, 'design', 'è²“çœ¼')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">è²“çœ¼ $1300</button>
                <button onclick="window.selectSingleOption(this, 1400, 'design', 'æ¼¸å±¤')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">æ¼¸å±¤ $1400</button>
                <button onclick="window.selectSingleOption(this, 1400, 'design', 'é¡é¢')" class="btn-toggle p-4 text-sm rounded-custom" data-group="design">é¡é¢ $1400</button>
            </div>
            <button onclick="window.selectSingleOption(this, 1550, 'design', 'äº”æŒ‡é€ å‹'); window.toggleDesignRule('rule-5', this)" class="btn-toggle w-full mb-2 p-4 text-sm rounded-custom flex justify-between" data-group="design"><span>äº”æŒ‡é€ å‹</span><span>$1550 up</span></button>
            <div id="rule-5" class="hidden rule-box mb-2">4-6æŒ‡é€ å‹ + å–®è‰²</div>
            <button onclick="window.selectSingleOption(this, 1650, 'design', 'åæŒ‡é€ å‹'); window.toggleDesignRule('rule-10', this)" class="btn-toggle w-full mb-2 p-4 text-sm rounded-custom flex justify-between" data-group="design"><span>åæŒ‡é€ å‹</span><span>$1650 up</span></button>
            <div id="rule-10" class="hidden rule-box mb-2">10æŒ‡çš†é€ å‹</div>
            <button onclick="window.selectSingleOption(this, 1450, 'design', 'ä»»æˆ‘åš'); window.toggleDesignRule('rule-any', this)" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="design"><span>âœ¨ ä»»æˆ‘åš</span><span>$1450</span></button>
            <div id="rule-any" class="hidden rule-box bg-gray-800 text-gray-100">
                <p class="text-xs mb-2">çµ¦æˆ‘2å€‹é—œéµå­—ä»»æˆ‘ç™¼æ®</p>
                <div class="flex gap-2">
                    <input id="keyword1" type="text" placeholder="é—œéµå­— 1" maxlength="10" oninput="window.validate()" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded text-sm outline-none border border-gray-600 focus:border-gray-400">
                    <input id="keyword2" type="text" placeholder="é—œéµå­— 2" maxlength="10" oninput="window.validate()" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded text-sm outline-none border border-gray-600 focus:border-gray-400">
                </div>
            </div>
        </section>

        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase">02 / Removal å¸ç”²</h2>
            <div class="space-y-2">
                <button onclick="window.selectSingleOption(this, 0, 'removal', 'ç„¡é ˆå¸ç”²')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal"><span>ç„¡é ˆå¸ç”²</span><span>$0</span></button>
                <button onclick="window.selectSingleOption(this, 100, 'removal', 'æœ¬åº—4å‘¨å…§å¸ç”²åŠåƒ¹')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal"><span>æœ¬åº—4å‘¨å…§å¸ç”²åŠåƒ¹ ğŸ‰</span><span>$100</span></button>
                <button onclick="window.selectSingleOption(this, 200, 'removal', 'æœ¬åº—å¸ç”²çºŒä½œ')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal"><span>æœ¬åº—å¸ç”²çºŒä½œ</span><span>$200</span></button>
                <button onclick="window.selectSingleOption(this, 400, 'removal', 'ä»–åº—å¸ç”²çºŒä½œ')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal"><span>ä»–åº—å¸ç”²çºŒä½œ</span><span>$400</span></button>
                <button onclick="window.selectSingleOption(this, 500, 'removal', 'ç´”å¸ç”²')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between" data-group="removal"><span>ç´”å¸ç”²</span><span>$500</span></button>
            </div>
            <div class="mt-4 bg-gray-50 p-4 rounded-custom space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold">ç„¡é™è·³ç´”è‰² ($100/æ¬¡)</span>
                    <div class="flex items-center gap-3">
                        <button onclick="window.updateUnlimitedJumpCount(-1)" class="counter-btn"><i class="fas fa-minus"></i></button>
                        <span id="unlimited-jump-count" class="text-sm font-bold w-4 text-center">0</span>
                        <button onclick="window.updateUnlimitedJumpCount(1)" class="counter-btn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold">å¤§é‘½/å‡¹å‡¸ ($50/æŒ‡)</span>
                    <div class="flex items-center gap-3">
                        <button onclick="window.updateDiamondCount(-1)" class="counter-btn"><i class="fas fa-minus"></i></button>
                        <span id="diamond-count" class="text-sm font-bold w-4 text-center">0</span>
                        <button onclick="window.updateDiamondCount(1)" class="counter-btn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <button onclick="window.toggleService(this, 50, 'å¸æŒ‡ç”²æ²¹')" class="btn-toggle w-full p-3 text-xs rounded-custom text-left">å¸æŒ‡ç”²æ²¹ +$50</button>
            </div>
        </section>

        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase">03 / Care ä¿é¤Š</h2>
            <button onclick="window.toggleService(this, 400, 'åŸºç¤ä¿é¤Š')" class="btn-toggle w-full p-4 text-sm rounded-custom flex justify-between mb-3"><span>åŸºç¤ä¿é¤Š</span><span>$400</span></button>
            <div class="bg-gray-50 p-4 rounded-custom space-y-3">
                <div class="flex justify-between items-center"><span class="text-xs font-bold">å»¶ç”² ($150/æŒ‡)</span><div class="flex items-center gap-3"><button onclick="window.updateExtensionCount(-1)" class="counter-btn"><i class="fas fa-minus"></i></button><span id="ext-count" class="text-sm font-bold w-4 text-center">0</span><button onclick="window.updateExtensionCount(1)" class="counter-btn"><i class="fas fa-plus"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-bold">è£œç”² ($50/æŒ‡)</span><div class="flex items-center gap-3"><button onclick="window.updateRepairCount(-1)" class="counter-btn"><i class="fas fa-minus"></i></button><span id="repair-count" class="text-sm font-bold w-4 text-center">0</span><button onclick="window.updateRepairCount(1)" class="counter-btn"><i class="fas fa-plus"></i></button></div></div>
            </div>
        </section>

        <section class="mb-10">
            <h2 class="text-xs font-bold text-gray-400 mb-4 tracking-tighter uppercase">04 / Schedule æ™‚é–“</h2>
            <div class="bg-white p-6 rounded-custom shadow-sm border border-gray-100">
                <div class="flex justify-between items-end mb-4"><h3 id="calendar-title" class="text-xl font-bold text-gray-800"></h3><span class="text-[10px] text-gray-400">â— å¯é ç´„</span></div>
                <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs text-gray-400 font-bold"><div class="text-red-400">æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div class="text-blue-400">å…­</div></div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 mb-6"></div>
                <div id="time-slots-container" class="hidden pt-4 border-t border-gray-100 fade-in">
                    <p class="text-center text-xs text-gray-400 mb-3">é¸æ“‡æ™‚æ®µ (ç´„2.5å°æ™‚)</p>
                    <div id="time-slots-grid" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>
        </section>

        <section class="bg-gray-50 p-6 rounded-custom mb-24 text-xs text-gray-600">
            <p class="mb-4">é¦–æ¬¡é ç´„éœ€åŒ¯æ¬¾ <span class="font-bold text-black">$500</span> ä¿ç•™ã€‚</p>
            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="term-check" onchange="window.validate()" class="accent-gray-800"><span>æˆ‘å·²é–±è®€ä¸¦åŒæ„è¦ç¯„</span></label>
        </section>

        <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-gray-100 p-4 z-40">
            <div class="max-w-md mx-auto flex items-center justify-between">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase">Total</p>
                    <p class="text-xl font-bold text-gray-800">$<span id="price-display">0</span></p>
                    <p id="validation-msg" class="text-[9px] text-red-500 font-bold"></p>
                </div>
                <button id="submit-btn" onclick="window.checkAndSubmit()" class="bg-gray-900 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition opacity-50 flex items-center gap-2"><span>é€å‡ºé ç´„</span></button>
            </div>
        </footer>
    </main>

    <script>
        console.log('ğŸš€ Script started loading');
        
        const SUPABASE_URL = 'https://alkuncpbqslksxeorndz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsa3VuY3BicXNsa3N4ZW9ybmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzg0MjIsImV4cCI6MjA4MjkxNDQyMn0.Q-HxirPEavixO-tW6hRp6Rz6fFLrWMqfCU3kEKcrRAg';
        const LIFF_ID = '2008856015-4bLaPE5n';
        const LINE_OFFICIAL_ID = '@229lgsmd';

        let supabaseClient = null;
        if (typeof supabase !== 'undefined' && SUPABASE_URL.startsWith('http')) {
             supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
             console.log('âœ… Supabase initialized');
        }

        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const allTimeSlots = ['09:30', '12:00', '14:30', '17:00', '19:30'];
        
        let calendarData = [];
        let adminSelectedIndex = null;
        let closedDates = [];
        let bookingOpenRanges = { start: null, end: null };
        
        let priceState = { design: 0, removal: 0, extras: 0 };
        let bookingDetails = { 
            design: { name: '', price: 0, keywords: [] },
            removal: { name: '', price: 0 },
            extras: []
        };
        let diamondCount = 0; 
        let extensionCount = 0; 
        let repairCount = 0;
        let unlimitedJumpCount = 0;
        let selectedDate = null; 
        let selectedTime = null; 
        let userProfile = null;
        let liffInitialized = false;
        let isFriend = false;

        console.log('âœ… Variables initialized');

        window.showLoginScreen = function() {
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-overlay').classList.remove('hidden');
        }

        window.updateUserStatus = function() {
            const warningEl = document.getElementById('line-login-warning');
            const friendWarningEl = document.getElementById('friend-warning');
            const statusEl = document.getElementById('user-status');
            const userNameEl = document.getElementById('user-name');
            
            if (!userProfile || !userProfile.userId) {
                warningEl.classList.remove('hidden');
                friendWarningEl.classList.add('hidden');
                statusEl.innerText = 'âš ï¸ è¨ªå®¢æ¨¡å¼ï¼ˆç„¡æ³•é ç´„ï¼‰';
                statusEl.classList.add('text-red-500', 'font-bold');
                userNameEl.innerText = 'è¨ªå®¢';
            } else if (!isFriend) {
                warningEl.classList.add('hidden');
                friendWarningEl.classList.remove('hidden');
                statusEl.innerText = 'âš ï¸ å»ºè­°åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ';
                statusEl.classList.add('text-orange-500', 'font-bold');
                statusEl.classList.remove('text-green-600', 'text-red-500');
                userNameEl.innerText = userProfile.displayName;
            } else {
                warningEl.classList.add('hidden');
                friendWarningEl.classList.add('hidden');
                statusEl.innerText = 'âœ“ LINE å¸³è™Ÿå·²é€£çµ';
                statusEl.classList.remove('text-red-500', 'text-orange-500');
                statusEl.classList.add('text-green-600');
                userNameEl.innerText = userProfile.displayName;
            }
        }

        window.checkFriendship = async function() {
            if (!liffInitialized || !liff.isLoggedIn()) {
                console.warn("âš ï¸ LIFF æœªåˆå§‹åŒ–æˆ–æœªç™»å…¥ï¼Œè·³éå¥½å‹æª¢æŸ¥");
                isFriend = true;
                return true;
            }
            
            try {
                const friendship = await liff.getFriendship();
                isFriend = friendship.friendFlag;
                console.log(isFriend ? "âœ… ç”¨æˆ¶å·²åŠ ç‚ºå¥½å‹" : "âŒ ç”¨æˆ¶å°šæœªåŠ ç‚ºå¥½å‹");
                return isFriend;
            } catch (e) {
                console.error("âš ï¸ ç„¡æ³•æª¢æŸ¥å¥½å‹ç‹€æ…‹", e);
                isFriend = true;
                return true;
            }
        }

        window.addFriend = function() {
            if (LINE_OFFICIAL_ID && LINE_OFFICIAL_ID !== '@your_line_id') {
                window.open(`https://line.me/R/ti/p/${LINE_OFFICIAL_ID}`, '_blank');
            } else {
                alert("è«‹å…ˆè¨­å®š LINE_OFFICIAL_ID");
            }
        }

        window.recheckFriendship = async function() {
            window.showLoading(true);
            await window.checkFriendship();
            window.updateUserStatus();
            window.showLoading(false);
            
            if (isFriend) {
                alert("âœ… å·²ç¢ºèªæ‚¨æ˜¯æˆ‘å€‘çš„å¥½å‹ï¼\nç¾åœ¨å¯ä»¥æ­£å¸¸é ç´„äº†ã€‚");
            } else {
                alert("âŒ å°šæœªåµæ¸¬åˆ°å¥½å‹é—œä¿‚\n\nè«‹ç¢ºèªï¼š\n1. å·²åœ¨ LINE ä¸­åŠ å…¥æˆ‘å€‘çš„å®˜æ–¹å¸³è™Ÿ\n2. ç¨ç­‰ç‰‡åˆ»å†è©¦ä¸€æ¬¡");
            }
        }

        window.loginWithLine = async function() {
            console.log('ğŸ” loginWithLine called');
            sessionStorage.removeItem('manualLogout');
            if (LIFF_ID && LIFF_ID !== 'YOUR_LIFF_ID_HERE') {
                if (!liff.isLoggedIn()) {
                    try {
                        console.log('ğŸ”„ Redirecting to LINE login...');
                        liff.login({ redirectUri: window.location.href });
                    } catch (err) {
                        console.error('âŒ LINE login error:', err);
                        alert("LINE ç™»å…¥éŒ¯èª¤ï¼š\n" + err.message);
                    }
                } else {
                    try {
                        console.log('âœ… Already logged in, getting profile...');
                        userProfile = await liff.getProfile();
                        await window.checkFriendship();
                        document.getElementById('login-overlay').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        window.updateUserStatus();
                        await window.fetchCalendarData();
                        document.getElementById('calendar-title').innerText = `${monthNames[currentMonth]} ${currentYear}`;
                        window.renderCalendar();
                    } catch (e) {
                        console.error('âŒ Error getting LINE data:', e);
                        alert("ç„¡æ³•å–å¾— LINE è³‡æ–™ï¼š" + e.message);
                    }
                }
            } else {
                alert("è«‹è¨­å®š LIFF ID");
            }
        }

        window.toggleAdminLogin = function(show) {
            document.getElementById('login-customer-view').classList.toggle('hidden', show);
            document.getElementById('login-admin-view').classList.toggle('hidden', !show);
        }

        window.doAdminLogin = function() {
            sessionStorage.removeItem('manualLogout');
            if (document.getElementById('admin-id').value === 'admin' && document.getElementById('admin-pwd').value === '1234') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-panel').style.display = 'flex';
                window.fetchCalendarData().then(() => window.renderAdminCalendar());
            } else {
                alert('å¸³è™Ÿ admin / å¯†ç¢¼ 1234');
            }
        }

        window.logout = function() {
            sessionStorage.setItem('manualLogout', 'true');
            try { if (typeof liff !== 'undefined' && liff.isLoggedIn()) liff.logout(); } catch (e) {}
            location.reload();
        }

        window.selectSingleOption = function(el, price, group, name) {
            document.querySelectorAll(`button[data-group="${group}"]`).forEach(b => b.classList.remove('active'));
            if (group === 'design') {
                document.querySelectorAll('.rule-box').forEach(b => b.classList.add('hidden'));
                document.getElementById('keyword1').value = '';
                document.getElementById('keyword2').value = '';
            }
            el.classList.add('active');
            priceState[group] = price;
            
            if (group === 'design') {
                bookingDetails.design = { name: name || '', price: price, keywords: [] };
            } else if (group === 'removal') {
                bookingDetails.removal = { name: name || '', price: price };
            }
            
            window.updateUI();
        }

        window.toggleService = function(el, price, name) {
            if (el.classList.contains('active')) { 
                el.classList.remove('active'); 
                priceState.extras -= price;
                bookingDetails.extras = bookingDetails.extras.filter(e => e.name !== name);
            }
            else { 
                el.classList.add('active'); 
                priceState.extras += price;
                bookingDetails.extras.push({ name: name || 'åŠ è³¼é …ç›®', price: price });
            }
            window.updateUI();
        }

        window.toggleDesignRule = function(id, el) {
            const rule = document.getElementById(id);
            if (el.classList.contains('active')) rule.classList.remove('hidden');
            else rule.classList.add('hidden');
        }

        window.updateDiamondCount = function(n) {
            if (diamondCount + n >= 0) { diamondCount += n; document.getElementById('diamond-count').innerText = diamondCount; window.updateUI(); }
        }
        window.updateExtensionCount = function(n) {
            if (extensionCount + n >= 0) { extensionCount += n; document.getElementById('ext-count').innerText = extensionCount; window.updateUI(); }
        }
        window.updateRepairCount = function(n) {
            if (repairCount + n >= 0) { repairCount += n; document.getElementById('repair-count').innerText = repairCount; window.updateUI(); }
        }
        window.updateUnlimitedJumpCount = function(n) {
            if (unlimitedJumpCount + n >= 0) { 
                unlimitedJumpCount += n; 
                document.getElementById('unlimited-jump-count').innerText = unlimitedJumpCount; 
                window.updateUI(); 
            }
        }

        window.calculateTotal = function() {
            return priceState.design + priceState.removal + priceState.extras + 
                   (unlimitedJumpCount * 100) + (diamondCount * 50) + (extensionCount * 150) + (repairCount * 50);
        }

        window.updateUI = function() {
            const total = window.calculateTotal();
            const priceEl = document.getElementById('price-display');
            priceEl.innerText = total;
            if (total === 0) priceEl.classList.add('text-red-500'); else priceEl.classList.remove('text-red-500');
            window.validate();
        }

        window.validate = function() {
            const check = document.getElementById('term-check').checked;
            const total = window.calculateTotal();
            const btn = document.getElementById('submit-btn');
            const msgEl = document.getElementById('validation-msg');
            
            let errors = [];
            if (!userProfile || !userProfile.userId) errors.push("éœ€ LINE ç™»å…¥");
            if (total <= 0) errors.push("æœªé¸é …ç›®");
            
            if (bookingDetails.design.name === 'ä»»æˆ‘åš') {
                const k1 = document.getElementById('keyword1').value.trim();
                const k2 = document.getElementById('keyword2').value.trim();
                if (!k1 || !k2) errors.push("ä»»æˆ‘åšéœ€å¡«é—œéµå­—");
            }
            
            if (!selectedDate) errors.push("æœªé¸æ—¥æœŸ");
            if (!selectedTime) errors.push("æœªé¸æ™‚é–“");
            if (!check) errors.push("æœªå‹¾é¸åŒæ„");

            const isValid = errors.length === 0;

            if (isValid) {
                btn.classList.remove('opacity-50');
                msgEl.innerText = '';
            } else {
                btn.classList.add('opacity-50');
                msgEl.innerText = errors.join(' / ');
            }
            btn.disabled = false;
        }

        window.checkAndSubmit = async function() {
            const check = document.getElementById('term-check').checked;
            const total = window.calculateTotal();
            
            if (!userProfile || !userProfile.userId) {
                alert("âŒ è«‹å…ˆä½¿ç”¨ LINE ç™»å…¥æ‰èƒ½é ç´„ï¼");
                window.showLoginScreen();
                return;
            }
            
            if (!isFriend) {
                const confirmBooking = confirm("âš ï¸ å»ºè­°åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ\n\né›–ç„¶å¯ä»¥ç¹¼çºŒé ç´„ï¼Œä½†åŠ å…¥å®˜æ–¹å¸³è™Ÿå¾Œæ‰èƒ½æ”¶åˆ°é ç´„é€šçŸ¥ã€‚\n\næ˜¯å¦ä»è¦ç¹¼çºŒé ç´„ï¼Ÿ");
                if (!confirmBooking) {
                    document.getElementById('friend-warning').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
            }
            
            if (total <= 0) { alert("âŒ æ‚¨å°šæœªé¸æ“‡ä»»ä½•æœå‹™é …ç›®ï¼"); return; }
            
            if (bookingDetails.design.name === 'ä»»æˆ‘åš') {
                const k1 = document.getElementById('keyword1').value.trim();
                const k2 = document.getElementById('keyword2').value.trim();
                if (!k1 || !k2) {
                    alert("âŒ ä»»æˆ‘åšéœ€è¦å¡«å¯«å…©å€‹é—œéµå­—ï¼");
                    document.getElementById('keyword1').focus();
                    return;
                }
            }
            
            if (!selectedDate) { alert("âŒ è«‹é¸æ“‡é ç´„æ—¥æœŸ"); return; }
            if (!selectedTime) { alert("âŒ è«‹é¸æ“‡é ç´„æ™‚æ®µ"); return; }
            if (!check) { alert("âŒ è«‹å…ˆå‹¾é¸åŒæ„è¦ç¯„"); return; }

            try {
                await window.finalSubmit();
            } catch (e) {
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
            }
        }

        window.finalSubmit = async function() {
            if (!userProfile || !userProfile.userId) {
                alert("âŒ å®‰å…¨é©—è­‰å¤±æ•—");
                window.showLoginScreen();
                return;
            }
            if (!supabaseClient) {
                alert("âŒ è³‡æ–™åº«æœªé€£ç·š");
                return;
            }
            
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            btn.disabled = true;

            try {
                const dateId = `${currentYear}-${currentMonth}-${selectedDate.split('/')[1]}`;
                const { data, error: fetchErr } = await supabaseClient.from('calendar_slots').select('*').eq('date_id', dateId).single();
                let booked = (data && data.booked_slots) ? data.booked_slots : [];
                
                if (booked.some(s => (typeof s === 'string' ? s : s.time) === selectedTime)) throw new Error("æ‰‹è…³å¤ªæ…¢äº†ï¼è©²æ™‚æ®µå‰›è¢«æ¶èµ° ğŸ˜­");
                
                let userName = userProfile.displayName;
                let userId = userProfile.userId;
                
                let details = {
                    design: { ...bookingDetails.design },
                    removal: { ...bookingDetails.removal },
                    extras: [...bookingDetails.extras]
                };
                
                if (bookingDetails.design.name === 'ä»»æˆ‘åš') {
                    details.design.keywords = [
                        document.getElementById('keyword1').value.trim(),
                        document.getElementById('keyword2').value.trim()
                    ];
                }
                
                if (unlimitedJumpCount > 0) details.extras.push({ name: 'ç„¡é™è·³ç´”è‰²', count: unlimitedJumpCount, price: unlimitedJumpCount * 100 });
                if (diamondCount > 0) details.extras.push({ name: 'å¤§é‘½/å‡¹å‡¸', count: diamondCount, price: diamondCount * 50 });
                if (extensionCount > 0) details.extras.push({ name: 'å»¶ç”²', count: extensionCount, price: extensionCount * 150 });
                if (repairCount > 0) details.extras.push({ name: 'è£œç”²', count: repairCount, price: repairCount * 50 });
                
                booked.push({
                    time: selectedTime,
                    user: userName,
                    userId: userId,
                    status: 'pending',
                    bookingDetails: details,
                    totalPrice: window.calculateTotal()
                });

                const { error } = await supabaseClient.from('calendar_slots').upsert({ date_id: dateId, booked_slots: booked, status: 'available' });
                if (error) throw error;
                
                let detailMsg = '';
                if (details.design.name) {
                    detailMsg += `\nğŸ¨ é€ å‹ï¼š${details.design.name}`;
                    if (details.design.keywords && details.design.keywords.length > 0) {
                        detailMsg += ` (${details.design.keywords.join(', ')})`;
                    }
                }
                if (details.removal.name) {
                    detailMsg += `\nğŸ’… å¸ç”²ï¼š${details.removal.name}`;
                }
                if (details.extras.length > 0) {
                    detailMsg += `\nâœ¨ åŠ è³¼ï¼š${details.extras.map(e => {
                        if (e.count) return `${e.name} x${e.count}`;
                        return e.name;
                    }).join(', ')}`;
                }
                
                const successMsg = `ã€é ç´„å·²é€å‡ºã€‘

æ‚¨å¥½ ${userName}ï¼Œ
æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ç”³è«‹ï¼

ğŸ“… æ—¥æœŸï¼š${selectedDate}
â° æ™‚é–“ï¼š${selectedTime}${detailMsg}
ğŸ’° é ä¼°é‡‘é¡ï¼š$${window.calculateTotal()}

â³ è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸
å¯©æ ¸é€šéå¾Œæˆ‘å€‘æœƒç«‹å³é€šçŸ¥æ‚¨ã€‚

æ„Ÿè¬æ‚¨çš„é ç´„ï¼

---
Nail Collector æ”¶è—å®¶`;

                try {
                    if (liffInitialized && liff.isInClient()) {
                        await liff.sendMessages([{
                            type: 'text',
                            text: successMsg
                        }]);
                        alert("âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼\n\nå·²åœ¨ LINE ç™¼é€ç¢ºèªè¨Šæ¯ã€‚");
                    } else {
                        alert(`âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼\n\n${successMsg}`);
                    }
                } catch (e) {
                    console.warn("LINE message failed", e);
                    alert(`âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼\n\n${successMsg}`);
                }
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (e) {
                alert("âŒ é ç´„å¤±æ•—ï¼š" + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        window.saveAdminSettings = async function() {
            if (!supabaseClient) { alert("é›¢ç·šæ¨¡å¼ç„¡æ³•å„²å­˜"); logout(); return; }
            
            if (!confirm('ç¢ºå®šè¦å„²å­˜æ‰€æœ‰è®Šæ›´å—ï¼Ÿ')) {
                return;
            }
            
            window.showLoading(true);
            try {
                const updates = calendarData.map(item => ({
                    date_id: `${currentYear}-${currentMonth}-${item.date}`, 
                    status: item.status, 
                    booked_slots: item.bookedSlots
                }));
                const { error: calError } = await supabaseClient.from('calendar_slots').upsert(updates);
                if (calError) throw calError;
                
                await window.saveClosedDates();
                
                alert("âœ… å„²å­˜æˆåŠŸï¼"); 
                window.logout();
            } catch (e) { 
                alert("âŒ å„²å­˜å¤±æ•—ï¼š" + e.message); 
                window.showLoading(false); 
            }
        }

        window.updateClosedDatesList = function() {
            const container = document.getElementById('closed-dates-items');
            if (!container) return;
            
            if (closedDates.length === 0) {
                container.innerHTML = '<p class="text-gray-400">ç„¡é—œé–‰æ—¥æœŸ</p>';
                return;
            }
            
            const sortedDates = [...closedDates].sort();
            const html = sortedDates.map(dateStr => {
                const parts = dateStr.split('-');
                const displayDate = `${parseInt(parts[1])+1}/${parts[2]}`;
                return `<span class="inline-block bg-red-50 text-red-700 px-2 py-0.5 rounded mr-1 mb-1 text-[9px] font-bold">${displayDate}</span>`;
            }).join('');
            
            container.innerHTML = html;
        }

        window.renderAdminCalendar = function() {
            const grid = document.getElementById('admin-calendar-grid');
            grid.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            calendarData.forEach((item, index) => {
                const div = document.createElement('div');
                let dayText = `<span class="text-xs font-bold text-gray-400 mb-1">${item.date}</span>`;
                if (item.bookedSlots && item.bookedSlots.length > 0) {
                     const sorted = [...item.bookedSlots].sort((a,b) => {
                         const ta = (typeof a==='string'?a:a.time);
                         const tb = (typeof b==='string'?b:b.time);
                         return ta.localeCompare(tb);
                     });
                     dayText += `<div class="w-full flex flex-col gap-0.5 overflow-hidden">`;
                     sorted.forEach(s => {
                         const t = (typeof s==='string'?s:s.time);
                         const u = (typeof s==='string'?'Admin':s.user);
                         const status = (typeof s==='object' && s.status) ? s.status : 'approved';
                         
                         let barClass = 'bar-confirmed';
                         if (status === 'pending') barClass = 'bar-pending';
                         else if (status === 'pending_payment') barClass = 'bar-pending-payment';
                         else if (status === 'confirmed' || status === 'approved') barClass = 'bar-confirmed';
                         
                         let displayUser = u.length > 3 ? u.substring(0,2)+'..' : u;
                         let statusIcon = '';
                         if (status === 'pending') statusIcon = 'â³';
                         else if (status === 'pending_payment') statusIcon = 'ğŸ’°';
                         else if (status === 'confirmed') statusIcon = 'âœ“';
                         
                         dayText += `<div class="booking-bar ${barClass}">${statusIcon}${t} ${displayUser}</div>`;
                     });
                     dayText += `</div>`;
                }

                div.innerHTML = dayText;
                div.className = `admin-day ${item.status === 'past' ? 'status-past' : ''} ${index === adminSelectedIndex ? 'selected' : ''}`;
                if (item.status === 'booked') div.className += ' bg-gray-50';
                
                div.onclick = () => window.selectAdminDate(index);
                if(item.status === 'available' && (!item.bookedSlots || item.bookedSlots.length === 0)) {
                   const dot = document.createElement('div');
                   dot.className = "indicator-dot bg-green-400";
                   div.appendChild(dot);
                }
                grid.appendChild(div);
            });
            
            window.updateClosedDatesList();
        }

        window.selectAdminDate = function(index) {
            adminSelectedIndex = index;
            window.renderAdminCalendar();
            const item = calendarData[index];
            document.getElementById('admin-edit-area').classList.remove('hidden');
            document.getElementById('admin-edit-date-title').innerText = `${currentMonth+1} / ${item.date}`;
            
            window.updateCloseDateButton();

            const listContainer = document.getElementById('admin-schedule-list');
            listContainer.innerHTML = '';

            if (item.status === 'booked') {
                listContainer.innerHTML = `<div class="text-center p-4 bg-gray-100 rounded text-gray-500">ğŸš« æœ¬æ—¥å·²è¨­ç‚ºå…¬ä¼‘</div>`;
            } else {
                allTimeSlots.forEach(time => {
                    const booking = item.bookedSlots.find(s => (typeof s === 'string' ? s : s.time) === time);
                    let isBooked = !!booking;
                    let userName = 'Admin';
                    let status = 'approved';
                    let paymentDeadline = null;
                    let bookingDetails = null;
                    let totalPrice = 0;

                    if (booking && typeof booking === 'object') {
                        userName = booking.user;
                        status = booking.status || 'approved';
                        paymentDeadline = booking.paymentDeadline;
                        bookingDetails = booking.bookingDetails;
                        totalPrice = booking.totalPrice || 0;
                    } else if (booking && typeof booking === 'string') {
                        userName = 'Admin/Legacy';
                        status = 'approved';
                    }

                    const row = document.createElement('div');
                    row.className = 'schedule-item shadow-sm';
                    let contentHtml = '';
                    
                    let detailsHtml = '';
                    if (bookingDetails) {
                        detailsHtml = '<div class="text-xs text-gray-600 bg-gray-50 p-2 rounded mb-2">';
                        if (bookingDetails.design && bookingDetails.design.name) {
                            detailsHtml += `<div class="mb-1"><span class="font-bold">é€ å‹ï¼š</span>${bookingDetails.design.name}`;
                            if (bookingDetails.design.keywords && bookingDetails.design.keywords.length > 0) {
                                detailsHtml += ` (${bookingDetails.design.keywords.join(', ')})`;
                            }
                            detailsHtml += `</div>`;
                        }
                        if (bookingDetails.removal && bookingDetails.removal.name) {
                            detailsHtml += `<div class="mb-1"><span class="font-bold">å¸ç”²ï¼š</span>${bookingDetails.removal.name}</div>`;
                        }
                        if (bookingDetails.extras && bookingDetails.extras.length > 0) {
                            detailsHtml += `<div><span class="font-bold">åŠ è³¼ï¼š</span>${bookingDetails.extras.map(e => {
                                if (e.count) return `${e.name} x${e.count}`;
                                return e.name;
                            }).join(', ')}</div>`;
                        }
                        detailsHtml += `<div class="mt-1 font-bold text-gray-800">ç¸½è¨ˆï¼š$${totalPrice}</div>`;
                        detailsHtml += '</div>';
                    }

                    if (!isBooked) {
                        contentHtml = `
                            <div class="schedule-header"><span class="font-bold text-gray-700">${time}</span><span class="tag tag-open">é–‹æ”¾ä¸­</span></div>
                            <div class="schedule-actions"><button onclick="toggleAdminSlot(${index}, '${time}')" class="text-xs border border-gray-300 px-3 py-1 rounded hover:bg-gray-100">é–å®š</button></div>`;
                    } else {
                        if (status === 'pending') {
                            contentHtml = `
                                <div class="schedule-header"><span class="font-bold text-gray-800">${time}</span><span class="tag tag-pending">å¾…å¯©æ ¸</span></div>
                                <div class="text-sm mb-2 text-gray-600">é ç´„äººï¼š<span class="font-bold">${userName}</span></div>
                                ${detailsHtml}
                                <div class="flex flex-col gap-2 mb-2">
                                    <button onclick="window.approveBooking(${index}, '${time}')" class="w-full text-xs bg-green-600 text-white px-3 py-2 rounded font-bold shadow hover:bg-green-700">âœ… ç¢ºèªé ç´„ï¼ˆå…è¨‚é‡‘ï¼‰</button>
                                    <button onclick="window.approveBookingWithPayment(${index}, '${time}')" class="w-full text-xs bg-blue-600 text-white px-3 py-2 rounded font-bold shadow hover:bg-blue-700">ğŸ’° ç¢ºèªï¼ˆéœ€ä»˜è¨‚é‡‘ $500ï¼‰</button>
                                </div>
                                <div class="schedule-actions">
                                    <button onclick="window.rejectBooking(${index}, '${time}')" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200">âŒ æ‹’çµ•</button>
                                </div>`;
                        } else if (status === 'pending_payment') {
                            contentHtml = `
                                <div class="schedule-header"><span class="font-bold text-gray-800">${time}</span><span class="tag tag-pending-payment">å¾…ä»˜æ¬¾</span></div>
                                <div class="text-sm mb-2 text-gray-600">é ç´„äººï¼š<span class="font-bold">${userName}</span></div>
                                ${detailsHtml}
                                <div class="text-xs text-orange-700 mb-3 bg-orange-50 p-2 rounded">ğŸ’° ç­‰å¾…å®¢äººåŒ¯æ¬¾è¨‚é‡‘ $500</div>
                                <div class="schedule-actions">
                                    <button onclick="rejectBooking(${index}, '${time}')" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200">å–æ¶ˆé ç´„</button>
                                    <button onclick="confirmPayment(${index}, '${time}')" class="text-xs bg-green-600 text-white px-3 py-1 rounded font-bold shadow hover:bg-green-700">å·²æ”¶æ¬¾ âœ…</button>
                                </div>`;
                        } else if (status === 'confirmed') {
                            let paymentInfo = '';
                            if (paymentDeadline) {
                                paymentInfo = '<div class="text-xs text-green-600 mb-2">âœ… å·²æ”¶è¨‚é‡‘ $500</div>';
                            } else {
                                paymentInfo = '<div class="text-xs text-blue-600 mb-2">âœ… å…è¨‚é‡‘</div>';
                            }
                            contentHtml = `
                                <div class="schedule-header"><span class="font-bold text-gray-800">${time}</span><span class="tag tag-confirmed">å·²ç¢ºèª</span></div>
                                <div class="text-sm mb-2 text-gray-600">é ç´„äººï¼š${userName}</div>
                                ${detailsHtml}
                                ${paymentInfo}
                                <div class="schedule-actions"><button onclick="toggleAdminSlot(${index}, '${time}')" class="text-xs border border-red-200 text-red-500 px-3 py-1 rounded hover:bg-red-50">å–æ¶ˆé ç´„</button></div>`;
                        } else {
                            contentHtml = `
                                <div class="schedule-header"><span class="font-bold text-gray-800">${time}</span><span class="tag tag-confirmed">å·²é ç´„</span></div>
                                <div class="text-sm mb-2 text-gray-600">é ç´„äººï¼š${userName}</div>
                                ${detailsHtml}
                                <div class="schedule-actions"><button onclick="toggleAdminSlot(${index}, '${time}')" class="text-xs border border-red-200 text-red-500 px-3 py-1 rounded hover:bg-red-50">å–æ¶ˆé ç´„</button></div>`;
                        }
                    }
                    row.innerHTML = contentHtml;
                    listContainer.appendChild(row);
                });
            }
        }

        window.toggleDateClosed = function() {
            if (adminSelectedIndex === null) return;
            
            const item = calendarData[adminSelectedIndex];
            const dateStr = `${currentYear}-${currentMonth}-${item.date}`;
            const displayDate = `${currentMonth+1}/${item.date}`;
            const idx = closedDates.indexOf(dateStr);
            const btn = document.getElementById('admin-close-date-btn');
            
            if (idx >= 0) {
                if (!confirm(`ç¢ºå®šè¦é‡æ–°é–‹æ”¾ ${displayDate} å—ï¼Ÿ`)) {
                    return;
                }
                closedDates.splice(idx, 1);
                btn.classList.remove('bg-red-50', 'border-red-300', 'text-red-700');
                btn.classList.add('border-gray-300', 'text-gray-600');
                btn.innerText = 'æ‰‹å‹•é—œé–‰æ­¤æ—¥æœŸ';
                window.updateClosedDatesList();
                alert('âœ… æ—¥æœŸå·²é‡æ–°é–‹æ”¾');
            } else {
                const bookingCount = item.bookedSlots ? item.bookedSlots.length : 0;
                let confirmMsg = `âš ï¸ ç¢ºå®šè¦é—œé–‰ ${displayDate} å—ï¼Ÿ`;
                
                if (bookingCount > 0) {
                    confirmMsg += `\n\nç›®å‰æœ‰ ${bookingCount} å€‹é ç´„æœƒä¿ç•™ã€‚`;
                }
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                closedDates.push(dateStr);
                btn.classList.remove('border-gray-300', 'text-gray-600');
                btn.classList.add('bg-red-50', 'border-red-300', 'text-red-700');
                btn.innerText = 'âœ“ æ­¤æ—¥æœŸå·²é—œé–‰';
                window.updateClosedDatesList();
                alert('âœ… æ—¥æœŸå·²é—œé–‰');
            }
        }

        window.updateCloseDateButton = function() {
            if (adminSelectedIndex === null) return;
            const item = calendarData[adminSelectedIndex];
            const dateStr = `${currentYear}-${currentMonth}-${item.date}`;
            const btn = document.getElementById('admin-close-date-btn');
            
            if (closedDates.includes(dateStr)) {
                btn.classList.remove('border-gray-300', 'text-gray-600');
                btn.classList.add('bg-red-50', 'border-red-300', 'text-red-700');
                btn.innerText = 'âœ“ æ­¤æ—¥æœŸå·²é—œé–‰ï¼ˆé»æ“Šé‡æ–°é–‹æ”¾ï¼‰';
            } else {
                btn.classList.remove('bg-red-50', 'border-red-300', 'text-red-700');
                btn.classList.add('border-gray-300', 'text-gray-600');
                btn.innerText = 'æ‰‹å‹•é—œé–‰æ­¤æ—¥æœŸ';
            }
        }

        window.toggleAdminDateStatus = function() {
            if (adminSelectedIndex === null) return;
            const item = calendarData[adminSelectedIndex];
            const dateStr = `${currentMonth+1}/${item.date}`;
            const newStatus = (item.status === 'available') ? 'booked' : 'available';
            
            let confirmMsg = '';
            if (newStatus === 'booked') {
                const bookingCount = item.bookedSlots ? item.bookedSlots.length : 0;
                if (bookingCount > 0) {
                    confirmMsg = `âš ï¸ ç¢ºå®šè¦å°‡æ­¤æ—¥è¨­ç‚ºå…¬ä¼‘å—ï¼Ÿ\n\næ—¥æœŸï¼š${dateStr}\nç›®å‰æœ‰ ${bookingCount} å€‹é ç´„\n\nè¨­ç‚ºå…¬ä¼‘å¾Œï¼Œæ‰€æœ‰é ç´„å°‡è¢«åˆªé™¤ï¼`;
                } else {
                    confirmMsg = `ç¢ºå®šè¦å°‡ ${dateStr} è¨­ç‚ºå…¬ä¼‘å—ï¼Ÿ`;
                }
            } else {
                confirmMsg = `ç¢ºå®šè¦å°‡ ${dateStr} é‡æ–°é–‹æ”¾é ç´„å—ï¼Ÿ`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            item.status = newStatus;
            if(item.status === 'booked') item.bookedSlots = [];
            window.selectAdminDate(adminSelectedIndex);
        }

        window.toggleAdminSlot = function(index, time) {
            const slots = calendarData[index].bookedSlots;
            const idx = slots.findIndex(s => (typeof s === 'string' ? s : s.time) === time);
            
            if (idx >= 0) {
                const slot = slots[idx];
                const userName = (typeof slot === 'object') ? slot.user : 'Admin';
                const dateStr = `${currentMonth+1}/${calendarData[index].date}`;
                
                if (!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤æ­¤é ç´„å—ï¼Ÿ\n\næ—¥æœŸï¼š${dateStr}\næ™‚é–“ï¼š${time}\né ç´„äººï¼š${userName}`)) {
                    return;
                }
                slots.splice(idx, 1);
            } else {
                slots.push({ time: time, user: 'Admin', status: 'approved' });
            }
            window.selectAdminDate(index);
        }

        window.approveBooking = async function(index, time) {
            const slots = calendarData[index].bookedSlots;
            const slot = slots.find(s => s.time === time);
            if (!slot) return;
            
            if (!slot.userId) {
                alert("âŒ ç„¡æ³•ç™¼é€è¨Šæ¯ï¼šç¼ºå°‘ç”¨æˆ¶ ID");
                return;
            }
            
            slot.status = 'confirmed';
            await window.saveDateToDB(index);
            
            const dateStr = `${currentMonth+1}/${calendarData[index].date}`;
            
            let detailMsg = '';
            if (slot.bookingDetails) {
                const bd = slot.bookingDetails;
                if (bd.design && bd.design.name) {
                    detailMsg += `\nğŸ¨ é€ å‹ï¼š${bd.design.name}`;
                    if (bd.design.keywords && bd.design.keywords.length > 0) {
                        detailMsg += ` (${bd.design.keywords.join(', ')})`;
                    }
                }
                if (bd.removal && bd.removal.name) {
                    detailMsg += `\nğŸ’… å¸ç”²ï¼š${bd.removal.name}`;
                }
                if (bd.extras && bd.extras.length > 0) {
                    detailMsg += `\nâœ¨ åŠ è³¼ï¼š${bd.extras.map(e => {
                        if (e.count) return `${e.name} x${e.count}`;
                        return e.name;
                    }).join(', ')}`;
                }
            }
            
            const msg = `ã€é ç´„ç¢ºèªé€šçŸ¥ã€‘

Hi ${slot.user}ï¼Œ
æ‚¨çš„é ç´„å·²ç¢ºèªï¼

ğŸ“… æ—¥æœŸï¼š${dateStr}
â° æ™‚é–“ï¼š${slot.time}${detailMsg}
ğŸ’° é ä¼°é‡‘é¡ï¼š$${slot.totalPrice || 0}

âœ… é ç´„å®Œæˆ
æœŸå¾…æ‚¨çš„å…‰è‡¨ï¼

---
Nail Collector æ”¶è—å®¶`;
            
            window.showLoading(true);
            try {
                const response = await fetch('/api/send-line-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: slot.userId,
                        message: msg
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert("âœ… é ç´„å·²ç¢ºèªï¼Œè¨Šæ¯å·²è‡ªå‹•ç™¼é€çµ¦å®¢äººï¼");
                } else {
                    alert("âš ï¸ é ç´„å·²ç¢ºèªï¼Œä½†è¨Šæ¯ç™¼é€å¤±æ•—ï¼š" + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert("âŒ ç™¼é€è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
            } finally {
                window.showLoading(false);
                window.selectAdminDate(index);
            }
        }

        window.approveBookingWithPayment = async function(index, time) {
            const slots = calendarData[index].bookedSlots;
            const slot = slots.find(s => s.time === time);
            if (!slot) return;
            
            if (!slot.userId) {
                alert("âŒ ç„¡æ³•ç™¼é€è¨Šæ¯ï¼šç¼ºå°‘ç”¨æˆ¶ ID");
                return;
            }
            
            const paymentDeadline = new Date();
            paymentDeadline.setHours(paymentDeadline.getHours() + 24);
            
            slot.status = 'pending_payment';
            slot.paymentDeadline = paymentDeadline.toISOString();
            
            await window.saveDateToDB(index);
            
            const dateStr = `${currentMonth+1}/${calendarData[index].date}`;
            
            let detailMsg = '';
            if (slot.bookingDetails) {
                const bd = slot.bookingDetails;
                if (bd.design && bd.design.name) {
                    detailMsg += `\nğŸ¨ é€ å‹ï¼š${bd.design.name}`;
                    if (bd.design.keywords && bd.design.keywords.length > 0) {
                        detailMsg += ` (${bd.design.keywords.join(', ')})`;
                    }
                }
                if (bd.removal && bd.removal.name) {
                    detailMsg += `\nğŸ’… å¸ç”²ï¼š${bd.removal.name}`;
                }
                if (bd.extras && bd.extras.length > 0) {
                    detailMsg += `\nâœ¨ åŠ è³¼ï¼š${bd.extras.map(e => {
                        if (e.count) return `${e.name} x${e.count}`;
                        return e.name;
                    }).join(', ')}`;
                }
            }
            
            const msg = `ã€é ç´„å¯©æ ¸é€šéã€‘

Hi ${slot.user}ï¼Œ
æ‚¨çš„é ç´„å·²é€šéå¯©æ ¸ï¼

ğŸ“… æ—¥æœŸï¼š${dateStr}
â° æ™‚é–“ï¼š${slot.time}${detailMsg}
ğŸ’° é ä¼°é‡‘é¡ï¼š$${slot.totalPrice || 0}

ğŸ’° è«‹åŒ¯æ¬¾è¨‚é‡‘ $500
åŒ¯æ¬¾å¾Œè«‹æˆªåœ–é€šçŸ¥æˆ‘å€‘ç¢ºèªã€‚

ã€åŒ¯æ¬¾è³‡è¨Šã€‘
éŠ€è¡Œï¼š(è«‹å¡«å…¥æ‚¨çš„éŠ€è¡Œ)
å¸³è™Ÿï¼š(è«‹å¡«å…¥æ‚¨çš„å¸³è™Ÿ)
æˆ¶åï¼š(è«‹å¡«å…¥æˆ¶å)

---
Nail Collector æ”¶è—å®¶`;
            
            window.showLoading(true);
            try {
                const response = await fetch('/api/send-line-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: slot.userId,
                        message: msg
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert("âœ… å¯©æ ¸é€šéï¼Œä»˜æ¬¾é€šçŸ¥å·²è‡ªå‹•ç™¼é€çµ¦å®¢äººï¼");
                } else {
                    alert("âš ï¸ å¯©æ ¸é€šéï¼Œä½†è¨Šæ¯ç™¼é€å¤±æ•—ï¼š" + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert("âŒ ç™¼é€è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
            } finally {
                window.showLoading(false);
                window.selectAdminDate(index);
            }
        }

        window.confirmPayment = async function(index, time) {
            if(!confirm("ç¢ºå®šå·²æ”¶åˆ°å®¢äººçš„ $500 è¨‚é‡‘å—ï¼Ÿ")) return;
            
            const slots = calendarData[index].bookedSlots;
            const slot = slots.find(s => s.time === time);
            if (!slot) return;
            
            if (!slot.userId) {
                alert("âŒ ç„¡æ³•ç™¼é€è¨Šæ¯ï¼šç¼ºå°‘ç”¨æˆ¶ ID");
                return;
            }
            
            slot.status = 'confirmed';
            slot.paidAt = new Date().toISOString();
            
            await window.saveDateToDB(index);
            
            const dateStr = `${currentMonth+1}/${calendarData[index].date}`;
            
            let detailMsg = '';
            if (slot.bookingDetails) {
                const bd = slot.bookingDetails;
                if (bd.design && bd.design.name) {
                    detailMsg += `\nğŸ¨ é€ å‹ï¼š${bd.design.name}`;
                    if (bd.design.keywords && bd.design.keywords.length > 0) {
                        detailMsg += ` (${bd.design.keywords.join(', ')})`;
                    }
                }
                if (bd.removal && bd.removal.name) {
                    detailMsg += `\nğŸ’… å¸ç”²ï¼š${bd.removal.name}`;
                }
                if (bd.extras && bd.extras.length > 0) {
                    detailMsg += `\nâœ¨ åŠ è³¼ï¼š${bd.extras.map(e => {
                        if (e.count) return `${e.name} x${e.count}`;
                        return e.name;
                    }).join(', ')}`;
                }
            }
            
            const msg = `ã€è¨‚é‡‘ç¢ºèªã€‘

Hi ${slot.user}ï¼Œ
æˆ‘å€‘å·²ç¢ºèªæ”¶åˆ°æ‚¨çš„è¨‚é‡‘ $500ï¼

ğŸ“… é ç´„æ—¥æœŸï¼š${dateStr}
â° é ç´„æ™‚é–“ï¼š${slot.time}${detailMsg}
ğŸ’° é ä¼°é‡‘é¡ï¼š$${slot.totalPrice || 0}

âœ… é ç´„ç¢ºèªå®Œæˆ
æœŸå¾…æ‚¨çš„å…‰è‡¨ï¼

---
Nail Collector æ”¶è—å®¶`;
            
            window.showLoading(true);
            try {
                const response = await fetch('/api/send-line-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: slot.userId,
                        message: msg
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert("âœ… æ”¶æ¬¾ç¢ºèªï¼Œé€šçŸ¥å·²è‡ªå‹•ç™¼é€çµ¦å®¢äººï¼");
                } else {
                    alert("âš ï¸ æ”¶æ¬¾ç¢ºèªï¼Œä½†è¨Šæ¯ç™¼é€å¤±æ•—ï¼š" + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert("âŒ ç™¼é€è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
            } finally {
                window.showLoading(false);
                window.selectAdminDate(index);
            }
        }

        window.rejectBooking = async function(index, time) {
            const slots = calendarData[index].bookedSlots;
            const slot = slots.find(s => s.time === time);
            
            if(!confirm(`ç¢ºå®šè¦æ‹’çµ• ${slot?.user || 'æ­¤'} çš„é ç´„å—ï¼Ÿ`)) return;
            
            const idx = slots.findIndex(s => s.time === time);
            if (idx < 0) return;
            
            const userName = slots[idx].user || 'å®¢äºº';
            const userId = slots[idx].userId;
            const dateStr = `${currentMonth+1}/${calendarData[index].date}`;
            
            let detailMsg = '';
            if (slots[idx].bookingDetails) {
                const bd = slots[idx].bookingDetails;
                if (bd.design && bd.design.name) {
                    detailMsg += `\nğŸ¨ é€ å‹ï¼š${bd.design.name}`;
                    if (bd.design.keywords && bd.design.keywords.length > 0) {
                        detailMsg += ` (${bd.design.keywords.join(', ')})`;
                    }
                }
                if (bd.removal && bd.removal.name) {
                    detailMsg += `\nğŸ’… å¸ç”²ï¼š${bd.removal.name}`;
                }
                if (bd.extras && bd.extras.length > 0) {
                    detailMsg += `\nâœ¨ åŠ è³¼ï¼š${bd.extras.map(e => {
                        if (e.count) return `${e.name} x${e.count}`;
                        return e.name;
                    }).join(', ')}`;
                }
            }
            
            slots.splice(idx, 1);
            await window.saveDateToDB(index);
            
            if (userId) {
                const msg = `ã€é ç´„é€šçŸ¥ã€‘

Hi ${userName}ï¼Œ

å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„é ç´„ç”³è«‹æœªèƒ½é€šéå¯©æ ¸ã€‚

ğŸ“… åŸç”³è«‹æ—¥æœŸï¼š${dateStr}
â° åŸç”³è«‹æ™‚é–“ï¼š${time}${detailMsg}

å¦‚æœ‰ç–‘å•æˆ–éœ€è¦æ”¹ç´„å…¶ä»–æ™‚æ®µï¼Œ
æ­¡è¿éš¨æ™‚èˆ‡æˆ‘å€‘è¯ç¹«ï¼

---
Nail Collector æ”¶è—å®¶`;
                
                window.showLoading(true);
                try {
                    const response = await fetch('/api/send-line-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: userId,
                            message: msg
                        })
                    });
                    
                    if (response.ok) {
                        alert("âœ… é ç´„å·²å–æ¶ˆï¼Œé€šçŸ¥å·²è‡ªå‹•ç™¼é€çµ¦å®¢äºº");
                    } else {
                        alert("âš ï¸ é ç´„å·²å–æ¶ˆï¼Œä½†è¨Šæ¯ç™¼é€å¤±æ•—");
                    }
                } catch (error) {
                    alert("âš ï¸ é ç´„å·²å–æ¶ˆï¼Œä½†ç™¼é€é€šçŸ¥æ™‚ç™¼ç”ŸéŒ¯èª¤");
                } finally {
                    window.showLoading(false);
                }
            } else {
                alert("âš ï¸ é ç´„å·²å–æ¶ˆï¼Œä½†ç„¡æ³•ç™¼é€é€šçŸ¥ï¼ˆç¼ºå°‘ç”¨æˆ¶ IDï¼‰");
            }
            
            window.selectAdminDate(index);
        }

        window.saveDateToDB = async function(index) {
            if (!supabaseClient) return;
            window.showLoading(true);
            const item = calendarData[index];
            try {
                const { error } = await supabaseClient.from('calendar_slots').upsert({
                    date_id: `${currentYear}-${currentMonth}-${item.date}`,
                    status: item.status,
                    booked_slots: item.bookedSlots
                });
                if(error) throw error;
            } catch(e) {
                alert("æ›´æ–°å¤±æ•—: " + e.message);
            } finally {
                window.showLoading(false);
            }
        }

        window.fetchCalendarData = async function() {
            window.showLoading(true);
            try {
                const { data, error } = await supabaseClient.from('calendar_slots').select('*');
                if (error) throw error;
                
                await window.loadClosedDates();
                
                window.initMockData(true);
                data.forEach(row => {
                    const parts = row.date_id.split('-');
                    if (parseInt(parts[0]) === currentYear && parseInt(parts[1]) === currentMonth) {
                        const d = parseInt(parts[2]);
                        if (calendarData[d-1]) {
                            calendarData[d-1].status = row.status;
                            calendarData[d-1].bookedSlots = row.booked_slots || [];
                        }
                    }
                });
            } catch (err) { 
                console.log('âš ï¸ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œä½¿ç”¨é è¨­è³‡æ–™:', err.message);
                window.initMockData(); 
            }
            finally { window.showLoading(false); }
        }

        window.initMockData = function(onlyStructure = false) {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            calendarData = [];
            for (let i = 1; i <= daysInMonth; i++) {
                let isPast = (currentMonth === today.getMonth() && i < today.getDate());
                let status = isPast ? 'past' : 'available';
                calendarData.push({ date: i, status: status, bookedSlots: [] });
            }
        }

        window.calculateBookingRange = function() {
            const now = new Date();
            const currentDay = now.getDate();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let targetMonth, targetYear;
            let rangeStart, rangeEnd;
            
            if (currentDay >= 25) {
                targetMonth = currentMonth + 1;
                targetYear = currentYear;
                if (targetMonth > 11) { targetMonth = 0; targetYear++; }
                rangeStart = new Date(targetYear, targetMonth, 1);
                rangeEnd = new Date(targetYear, targetMonth + 1, 0);
            } else if (currentDay >= 15) {
                targetMonth = currentMonth + 1;
                targetYear = currentYear;
                if (targetMonth > 11) { targetMonth = 0; targetYear++; }
                rangeStart = new Date(targetYear, targetMonth, 1);
                rangeEnd = new Date(targetYear, targetMonth, 15);
            } else {
                rangeStart = new Date(currentYear, currentMonth, 16);
                targetMonth = currentMonth + 1;
                targetYear = currentYear;
                if (targetMonth > 11) { targetMonth = 0; targetYear++; }
                rangeEnd = new Date(targetYear, targetMonth, 15);
            }
            
            bookingOpenRanges = { start: rangeStart, end: rangeEnd };
            console.log('ğŸ“… å¯é ç´„ç¯„åœ:', rangeStart.toLocaleDateString(), '-', rangeEnd.toLocaleDateString());
            return bookingOpenRanges;
        }

        window.showLoading = function(show) { document.getElementById('global-loading').style.display = show ? 'flex' : 'none'; }

        window.loadClosedDates = async function() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient
                    .from('booking_settings')
                    .select('setting_value')
                    .eq('setting_key', 'closed_dates')
                    .single();
                
                if (data && data.setting_value && data.setting_value.dates) {
                    closedDates = data.setting_value.dates;
                    console.log('ğŸ“… å·²è¼‰å…¥é—œé–‰æ—¥æœŸ:', closedDates);
                }
            } catch(e) {
                console.log('âš ï¸ ç„¡æ³•è¼‰å…¥é—œé–‰æ—¥æœŸè¨­å®š:', e.message);
            }
        }

        window.saveClosedDates = async function() {
            if (!supabaseClient) return;
            try {
                const { error } = await supabaseClient
                    .from('booking_settings')
                    .upsert({
                        setting_key: 'closed_dates',
                        setting_value: { dates: closedDates }
                    });
                
                if (error) throw error;
                console.log('âœ… é—œé–‰æ—¥æœŸå·²å„²å­˜');
            } catch(e) {
                console.error('âŒ å„²å­˜é—œé–‰æ—¥æœŸå¤±æ•—:', e.message);
            }
        }

        window.isDateBookable = function(year, month, day) {
            const checkDate = new Date(year, month, day);
            const dateStr = `${year}-${month}-${day}`;
            
            if (closedDates.includes(dateStr)) {
                return { bookable: false, reason: 'closed' };
            }
            
            if (!bookingOpenRanges.start || !bookingOpenRanges.end) {
                window.calculateBookingRange();
            }
            
            if (checkDate < bookingOpenRanges.start || checkDate > bookingOpenRanges.end) {
                return { bookable: false, reason: 'not-open' };
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (checkDate < today) {
                return { bookable: false, reason: 'past' };
            }
            
            return { bookable: true, reason: 'available' };
        }

        window.renderCalendar = function() {
            const grid = document.getElementById('calendar-grid'); 
            grid.innerHTML = '';
            const first = new Date(currentYear, currentMonth, 1).getDay();
            
            window.calculateBookingRange();
            
            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            
            calendarData.forEach(item => {
                const div = document.createElement('div');
                div.innerText = item.date;
                
                const dateCheck = window.isDateBookable(currentYear, currentMonth, item.date);
                
                let className = 'calendar-day';
                let clickable = false;
                
                if (dateCheck.reason === 'closed') {
                    className += ' closed';
                    div.title = 'æ­¤æ—¥æœŸå·²é—œé–‰';
                } else if (dateCheck.reason === 'not-open') {
                    className += ' not-open';
                    div.title = 'å°šæœªé–‹æ”¾é ç´„';
                } else if (dateCheck.reason === 'past' || item.status === 'past') {
                    className += ' booked';
                    div.title = 'å·²éæœŸ';
                } else if (item.status === 'booked') {
                    className += ' booked';
                    div.title = 'æœ¬æ—¥å…¬ä¼‘';
                } else if (dateCheck.bookable && item.status === 'available') {
                    clickable = true;
                    div.title = 'é»æ“Šé ç´„';
                }
                
                div.className = className;
                
                if(clickable) {
                    div.onclick = () => window.selectDate(div, item.date, item.bookedSlots);
                }
                
                grid.appendChild(div);
            });
        }

        window.selectDate = function(el, date, slots) {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected'); selectedDate = `${currentMonth+1}/${date}`;
            selectedTime = null;
            window.renderTimeSlots(slots); window.validate();
        }

        window.renderTimeSlots = function(booked) {
            const container = document.getElementById('time-slots-container'); container.classList.remove('hidden');
            const grid = document.getElementById('time-slots-grid'); grid.innerHTML = '';
            const available = allTimeSlots.filter(t => !booked.some(b => (typeof b === 'string' ? b : b.time) === t));
            if (available.length === 0) { grid.innerHTML = '<p class="col-span-2 text-center text-gray-300 text-sm py-2">æœ¬æ—¥å·²é¡æ»¿</p>'; return; }
            available.forEach(time => {
                const btn = document.createElement('button');
                btn.className = 'btn-toggle p-3 text-sm rounded-custom'; btn.innerText = time;
                btn.onclick = () => {
                    document.querySelectorAll('#time-slots-grid button').forEach(b => b.classList.remove('active', 'bg-gray-800', 'text-white'));
                    btn.classList.add('active', 'bg-gray-800', 'text-white'); selectedTime = time; window.validate();
                };
                grid.appendChild(btn);
            });
        }

        window.validate();

        console.log('ğŸ” Function check:');
        console.log('- loginWithLine:', typeof window.loginWithLine);
        console.log('- toggleAdminLogin:', typeof window.toggleAdminLogin);
        console.log('- doAdminLogin:', typeof window.doAdminLogin);
        console.log('- checkAndSubmit:', typeof window.checkAndSubmit);

        (async function init() {
            console.log('ğŸ¬ Init function started');
            if (LIFF_ID && LIFF_ID !== 'YOUR_LIFF_ID_HERE') {
                try {
                    console.log('ğŸ”„ Initializing LIFF...');
                    await liff.init({ liffId: LIFF_ID });
                    liffInitialized = true;
                    console.log('âœ… LIFF initialized successfully');
                    
                    if (!sessionStorage.getItem('manualLogout')) {
                        if (liff.isLoggedIn()) {
                            console.log('âœ… User is logged in, auto-login...');
                            document.getElementById('auto-login-hint').classList.remove('hidden');
                            
                            userProfile = await liff.getProfile();
                            await window.checkFriendship();
                            
                            document.getElementById('login-overlay').classList.add('hidden');
                            document.getElementById('main-app').classList.remove('hidden');
                            window.updateUserStatus();
                            
                            await window.fetchCalendarData();
                            document.getElementById('calendar-title').innerText = `${monthNames[currentMonth]} ${currentYear}`;
                            window.renderCalendar();
                        } else {
                            console.log('âš ï¸ User not logged in');
                            if (liff.isInClient()) {
                                console.log('ğŸ“± Running in LINE client, attempting auto-login...');
                                document.getElementById('auto-login-hint').classList.remove('hidden');
                                setTimeout(() => {
                                    liff.login({ redirectUri: window.location.href });
                                }, 1000);
                            }
                        }
                    }
                } catch (e) {
                    console.error("âŒ LIFF Init Failed:", e);
                    console.error("Error details:", {
                        message: e.message,
                        code: e.code,
                        liffId: LIFF_ID,
                        currentUrl: window.location.href,
                        isHttps: window.location.protocol === 'https:'
                    });
                    
                    const hint = document.getElementById('auto-login-hint');
                    hint.classList.remove('hidden', 'bg-blue-50', 'border-blue-200');
                    hint.classList.add('bg-red-50', 'border-red-200');
                    
                    let errorDetail = e.message;
                    let suggestion = '';
                    
                    if (e.message.includes('LIFF ID')) {
                        suggestion = 'è«‹æª¢æŸ¥ LIFF ID æ˜¯å¦æ­£ç¢º';
                    } else if (e.message.includes('Endpoint URL') || e.message.includes('redirect')) {
                        suggestion = 'è«‹æª¢æŸ¥ LINE Developers Console ä¸­çš„ Endpoint URL è¨­å®š';
                    } else if (window.location.protocol !== 'https:' && !window.location.hostname.includes('localhost')) {
                        suggestion = 'LIFF éœ€è¦ HTTPS ç’°å¢ƒ';
                    } else {
                        suggestion = 'è«‹æª¢æŸ¥ LINE Developers Console çš„æ‰€æœ‰è¨­å®š';
                    }
                    
                    hint.innerHTML = `
                        <div class="flex items-start gap-2 text-red-800 text-xs">
                            <i class="fas fa-exclamation-circle mt-0.5"></i>
                            <div>
                                <p class="font-bold mb-1">âŒ LIFF åˆå§‹åŒ–å¤±æ•—</p>
                                <p class="mb-1 text-red-700">éŒ¯èª¤: ${errorDetail}</p>
                                <p class="mb-2 text-red-600">ğŸ’¡ ${suggestion}</p>
                                <div class="flex gap-2">
                                    <button onclick="window.location.href='https://developers.line.biz/console/'" 
                                        class="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                        å‰å¾€ Console æª¢æŸ¥
                                    </button>
                                    <button onclick="window.location.reload()" 
                                        class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">
                                        é‡æ–°è¼‰å…¥
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            console.log('ğŸ Init function completed');
        })();

        console.log('âœ… Script fully loaded');
    </script>
</body>
</html>
